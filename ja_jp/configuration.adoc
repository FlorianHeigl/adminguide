[[managing_configuration]]
= 設定を管理する
:toc:

{product-abbrev} コンポーネントは、ソフトウェアの初回インストール時に設定されます。インストール後は本章で説明するように管理コンソールやCLIから、コンポーネントを管理することができます。

管理コンソールの使用方法等に関する *ヘルプ* は、管理コンソール内で提供しています。CLIからしか実行できないタスクは、<<cli_commands,Zimbra CLI コマンド>> でコマンドラインのユティリティの使用方法についての説明を参照してください。

== グローバル設定

グローバル設定はZimbraサーバー内の全てのアカウントに適用されます。グローバル設定はインストール中にあらかじめ設定されます。管理コンソールから設定を変更することもできます。

グローバル設定での設定内容は、デフォルト値としてサーバー、アカウント、提供サービス、ドメインのレベルに継承されます。こうしたレベルで属性が設定された場合、その設定はグローバル設定にオーバーライドします。

管理コンソール: ::
グローバル設定を設定するには次のように遷移します。  +
*ホーム > 設定 > グローバル設定*

設定済みのグローバル設定

* デフォルトドメイン
* GAL検索結果の最大件数。デフォルト値は100。
* 添付ファイルのユーザーへの表示方法と添付ファイルの拡張子制限。
* 認証プロセスの設定、外部配信用リレーMTA、DNS検索、プロトコルチェック。
* 迷惑メールチェックの制御と受信メッセージをチェックするための迷惑メール対策のオプション。
* {product-name}サーバーとサードパーティ製のサーバーに渡る、Free/Busyのスケジューリング。
* テーマのカスタマイズ: 配色の修正とロゴの追加。
* 外部ゲストによる共有ブリーフケースへのアクセス時、表示される会社名の設定。
* バックアップのデフォルトディレクトリとバックアップの通知情報。
* セカンダリストレージ領域へのメール移動のためのグローバルHSMスケジュール。
* 現在のZimbra ライセンス情報の表示、ライセンスの更新、作成済みアカウント数の表示。

[[general_information_configuration]]
== 全般情報の設定

管理コンソール: ::
*ホーム > 設定 > グローバル設定*

インストール・有効化されているサーバーのグローバルパラメーターの閲覧と設定は、 *全般情報* ページから行ないます。

[NOTE]
サーバーで定義した設定は、この全般情報ページで設定した内容をオーバーライドします。

image:ja_jp/administration_console_general_information_configuration.png[General Information]

. 要件に合うようにパラメーターを修正します。
. *ギア* アイコンから *保存* を選択します。

.全般情報のパラメーター
[cols=",a",options="header",]
|=======================================================================
|オプション |詳細

|GAL検索で取得できる結果の最大件数 |
ユーザー検索で返されるGAL検索結果の最大件数。ドメインでも設定できる値です。ドメインでの設定は、グローバル設定にオーバーライドします。 +
デフォルト値は100。

|デフォルトドメイン |
ユーザーがログインした際、アカウント認証で対象となるドメイン。


|同時に実行できる予定済みタスクの最大数|
外部データソースから取得するデータのスレッド数。

* この値を低く設定しすぎると、充分な頻度での外部ソースからのメール受信ができなくなります。
* この値を高く設定しすぎると、メールのダウンロードにサーバー負荷がかかり、主要である内部リクエストを正常に処理できなくなる恐れがあります。 +
デフォルト値は20。

|メールボックス削除のスリープ時間間隔 |

メールボックス削除のたびに"停止"するべき時間間隔です。メッセージ削除スケジュールを0に設定すると、メッセージは削除されません。そのため、メール、ゴミ箱、迷惑メールの保持期間を指定していたとしても、メッセージは削除されません。 +
デフォルトでは、1分毎のメッセージ削除がスケジュールされています。

|デスクトップからアップロードされるファイルの最大サイズ (KB)|
ブリーフケースにアップロードできる最大のファイルサイズです。

[NOTE]
送信できる１件あたりのメッセージと添付ファイルの最大サイズは、 *ホーム > 設定 > グローバル設定 > MTA* ページの *メッセージ* セクションで設定します。

|管理者ヘルプURL +
委任された管理者のヘルプURL|
{product-name} のヘルプを使用するには、管理コンソールのヘルプにあるリンクのURLを使用します。

|=======================================================================

[[attachments_configuration]]
== 添付の設定

=== 添付ファイルの処理ルールを設定する

グローバル設定の添付ファイル設定にて、メッセージの添付ファイルに関するグローバルルールを指定できます。提供サービスおよび各アカウントにてルールを設定することも可能です。グローバル設定に添付ファイルのルールを設定すると、提供サービス設定やアカウント設定に優先してグローバル設定が適用されます。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > 添付ファイル*

[cols=","]
image:ja_jp/administration_console_email_attachment_rules.png[Attachment Rules] +
この画面に関する詳細は
<<_blocking_email_attachments_by_file_type,拡張子から添付ファイルをブロックする>>
を参照してください。

.グローバル設定詳細
[cols=",",options="header",]
|=======================================================================
|オプション |詳細

|提供サービスの設定にかかわらず、添付ファイルを表示しない |
ユーザーは添付ファイルをいっさい閲覧できません。添付ファイルからのウイルス発生防止用にこのグローバル設定を利用することも可能です。いっさいの添付ファイルが開けないからです。

|提供サービスの設定にかかわらず、添付ファイルをHTML形式で表示 |
添付ファイルの閲覧はHTMLでのみ可能です。
提供サービスに他の設定をした場合も、このグローバル設定が提供サービス設定にオーバーライドします。

|提供サービスの設定に従って表示|
添付ファイルの表示方法は、提供サービスで設定したルールに従います。

|ブロックされている拡張子の通知を受信者に送信 |

|=======================================================================

[[_blocking_email_attachments_by_file_type]]
=== 拡張子から添付ファイルをブロックする

添付ファイルに特定の拡張子を伴うメッセージを拒否することもできます。 *一般的な拡張子* から承認しない拡張子を選択します。リストにない拡張子を追加することも可能です。こうした拡張子が添付ファイルに含まれているメッセージはすべて拒否されます。デフォルトでは、差出人と宛先にメッセージがブロックされた旨が通知されます。

メッセージがブロックされた際の通知を宛先に送信したくない場合、このオプションを無効にします。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > 添付ファイル*

[[mta_configuration]]
== MTA設定

MTAページのオプションを使用して、認証の有効/無効、リレーホスト名、メッセージの最大サイズ、DNS検索の有効化、プロトコルチェック、DNSチェックを設定します。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > MTA*

image:ja_jp/administation_console_mta_configuration.png[MTA Configuration]

.MTAページのオプション
[cols=",a"]
|=======================================================================
|オプション |詳細

|認証 |

* *認証* を有効にする：有効にしておく必要があります。モバイルSMTP認証ユーザーをサポートして、そのユーザーたちのメールクライアントがZimbra のMTAと会話できるようにします。

* *TLS認証のみ* ：すべてのSMTP認証にTransaction Level Security(処理レベルのセキュリティ)の使用を強制します。パスワードがそのままで通信されることを回避するためです。

|ネットワーク |

* *ウェブメールMTAホスト名とウェブメールMTAポート* : メール送信用にウェブサーバーが接続するMTA。デフォルトポート番号は25です。

* *外部配信用のリレーMTA* : リレーホスト名。これは、Postfixが外部メールをリレーするZimbraのMTAです。

* *受信SMTPホスト名*： MXレコードが、スパムリレーや外部のZimbra以外のサーバーを指している場合、そのサーバー名を入力します。このチェックは、ドメインのMX設定を属性zimbraInboundSmtpHostnameと比較します。この属性が設定されていない場合、ドメインのMXをzimbraSmtpHostnameと比較チェックします。

* *信頼できるMTAネットワーク* : メールをリレーしてよい信頼できるネットワークを設定します。複数のネットワークアドレスはカンマや空白で区切ります。

* *DNS* が有効な場合、Zimbra のMTAは、あて先ドメインのMXレコード検索用の明示的なDNSクエリーを実行します。このオプションを使用しない場合、外部配信用のリレーMTA項目に、リレーホストを入力してください。

* *ドメイン管理者が管理コンソールからMXレコードを確認できるようにする*  ： 有効な場合、ドメイン管理者はドメインのMXレコードをチェックできます。

|Milter サーバー |

* *Milterサーバーを有効にする* ： 有効な場合、配布リストへメール送信可能なユーザーに対するルールをMilterが強制できます。

|アーカイブ機能の設定 |
* アーカイブ機能をインストールした場合、ここで設定を有効化できます。

|メッセージ |

* *メッセージの最大サイズ(KB)* ： 送信できる１件あたりのメッセージと添付ファイルの最大サイズを設定できます。
+
[TIP]
ブリーフケースにアップロードできるファイルの最大サイズの設定を設定するには、全般情報ページに遷移します。

* *メッセージにX-Originating-IPを追加* ： *X-Originating-IP* ヘッダー情報で、サーバー転送されているメールメッセージの最初の送信元IPが特定できます。

|ポリシーサービスの確認 |
* *zimbraMtaRestriction* (疑わしいSMTPクライアントを拒否するためのチェック条件)をカスタマイズします。

|プロトコルチェック |
* 迷惑メール対策のため、迷惑メール(UCE)を拒否します。

|DNSチェック |
* 不明なクライアントIPアドレスや、不明な応答ホスト名、不明な送信者ドメインの場合にメッセージを拒否します。

* *RBLリスト* : メール宛先のその他の制限を入力します。

[NOTE]
RBL (リアルタイムブラックホールリスト) は、Zimbraのコマンドラインから有効/無効にできます。

|=======================================================================

=== グローバルのIMAPとPOP設定

グローバルアクセスの有効化は、IMAPページとPOPページから行ないます。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > IMAP* +
*ホーム > 設定 > グローバル設定 > POP*

[NOTE]
IMAPやPOPの設定を変更した場合、その反映に{product-name}を再起動する必要があります。

IMAP/POP3のポーリング間隔は提供サービスの詳細設定から指定できます。デフォルトはポーリング間隔なしです。

[NOTE]
IMAP/POPのプロキシがセットアップされていたら、そのポート番号が正しく設定されていることを確認してください。

POP3のおかげで、ユーザーはZimbraサーバーに保存されているメッセージの検索と、新着メッセージのローカルコンピュータへのダウンロードができます。*プリファレンス > メール* ページにあるユーザーのPOP設定により、メッセージのダウンロード方法と保存方法が決まります。

== ドメインの設定を管理する

ドメインはインストール中に１つ作成されます。インストール完了後にドメイン追加ができます。管理コンソールから以下のドメイン管理機能を使用できます。

* グローバルのアドレス帳(GAL)
* 認証
* ユーザーログイン時のデフォルトドメインを確立するための、そのドメイン用の仮想ホスト
* 共有等で使用される、REST URL用のパブリックサービスホスト名
* そのドメイン内で作成可能な最大アカウント数
* Microsoft Exchangeで利用するFree/Busyのインターオペラビリティ設定
* ドメインのSSL証明書

ドメインは名称変更できるので、この場合、アカウント、配布リスト、エイリアス、リソースのアドレスの全てが新しいドメイン名に切り替わります。CLIユーティリティを使用してドメイン名称を変更します。詳細は <<_renaming_a_domain,ドメイン名を変更する>>を参照してください。

[NOTE]
ドメイン設定はグローバル設定をオーバーライドします。

=== ドメインの全般情報を設定する

本項で説明するオプションの設定は、*新しいドメイン* ウィザードから行ないます。

管理コンソール: ::
*ホーム > 2 ドメインを設定 > 1 ドメインを作成...*

image:ja_jp/administration_console_create_domain.png[Create Domain]

.新しいドメイン -- 全般情報
[cols=",a",options="header"]
|=======================================================================
|オプション |詳細

|ドメイン名 * +
パブリックサーバーホスト名 |
REST URLのホスト名を入力します。この値はよくファイル共有で使用されます。詳細は以下の
<<_setting_up_a_public_service_host_name,公開サービスのホスト名を設定する>>を参照してください。

|パブリックサービスのポート |
ドロップダウンから、HTTP、HTTPSのいずれかを選択します。

|パブリックサービスのポート |

|受信SMTPホスト名 |
ドメインのMXレコードが、スパムリレーや外部のZimbra以外のサーバーを指している場合、そのサーバー名を入力します。

|説明 |

|デフォルトの提供サービス |
ドメインに作成されたアカウントに他の提供サービスが設定されていなければ、(そのドメインの)デフォルトの提供サービスが自動で適用されます。

|ステータス |
ドメインスのテータスは、通常の状態だとアクティブです。ユーザーはログインでき、メールは配信されます。このステータスを変更すると、そのドメインのアカウントのステータスにも影響が及ぶ可能性があります。ドメインのステータスは、
*ドメイン > 全般情報* ページに表示されます。ドメインのステータス値は以下のとおりです。

* *アクティブ* : 通常、ドメインのステータスは「アクティブ」です。アカウントを作成でき、メールは配信されます。
+
--
[NOTE]
アカウントのステータス設定がドメインのステータス設定と異なる場合、アカウントのステータスがドメインのステータスをオーバーライドします。
--

* *閉鎖* : ドメインのステータスが「閉鎖」のとき、ドメインのアカウントはログインできず、メッセージは送信元へバウンスされます。閉鎖ステータスは個々のアカウントのステータス設定をオーバーライドします。

* *ロック* :ドメインのステータスが「ロック」のとき、ドメインのアカウントはログインできませんが、メール配信はまだ続きます。アカウントのステータスが「メンテナンス」または「閉鎖」の場合、アカウントのステータスがドメインのステータスをオーバーライドします。

* *メンテナンス* : ドメインのステータスが「メンテナンス」のとき、ドメインのアカウントはログインできず、メールはMTAのキューに留まります。アカウントのステータスが「閉鎖」の場合、アカウントのステータスはドメインのステータスをオーバーライドします。

* *保留* : ドメインのステータスが「保留」のとき、ドメインのアカウントはログインできず、メールはMTAのキューに留まり、アカウントも配布リストも作成、削除、変更できません。アカウントのステータスが「閉鎖」の場合、アカウントのステータスがドメインステータスの設定をオーバーライドします。
|=======================================================================

[[_setting_up_a_public_service_host_name]]
==== 公開サービスのホスト名を設定する

REST URL用のパブリックサービスホスト名をドメインごとに設定できます。REST URLは、メールフォルダ、ブリーフケースフォルダ、タスクリスト、アドレス帳、カレンダーの共有時に使用されます。

ユーザーが{product-name} フォルダを共有したとき、デフォルトでは次のように、Zimbraサーバーホスト名とZimbraサービスホスト名からURLが作成されます。
*https://server.domain.com/service/home/username/sharedfolder*

作成される属性

* ホスト名:server.zimbraServiceHostname。
* プロトコル:server.zimbraMailMode から決定されます。
* ポート番号:プロトコルから算出されます。

パブリックサービスホスト名を設定すると、その名称が次のようにサーバー名とサービス名の代わりに使用されます。
*https://publicservicename.domain.com/home/username/sharedfolder*

使用される属性

* +zimbraPublicServiceHostname+
* +zimbraPublicServiceProtocol+
* +zimbraPublicServicePort+

他のFQDNのDNS情報にて、Zimbraサーバーへ内部と外部で転送するように設定すると、パブリックサービスホストとして使用することができます。

=== グローバルアドレス帳(GAL)モードの設定

グローバルアドレス帳(GAL)は企業全体のユーザーリストのことで、メールシステムにいる全てのユーザーが、GALを参照できます。GALはメールシステムでよく使われる機能であり、ユーザーが正確なメールアドレスを覚えていなくても姓や名から他のユーザーを検索できるようにします。

GALはドメイン単位で設定されます。各ドメインのGALモード設定によって、GAL検索の対象を指定します。

グローバルアドレス帳(GAL)の定義は、ドメイン設定で *GALモード設定* ツールから行ないます。

管理コンソール: ::
*ホーム > 2 ドメインを設定 > 1 ドメインを作成... -> GALモード設定*

image:ja_jp/administration_console_gal.png[GAL Mode Settings]

.新しいドメイン -- GALモード設定
[cols=",a",options="header"]
|=======================================================================
|オプション |説明

|GALモード |

* *内部* : ZimbraのLDAPサーバーがディレクトリ検索に使用されます。

* *外部* : 外部のディレクトリサーバーがGAL検索に使用されます。GAL用に外部LDAPホストを複数、設定できます。(設定、メール配信など)他のディレクトリサービスはZimbraのLDAPを使用します。外部GALモードを設定する場合、別の検索設定と同期設定を設定することができます。別の検索設定を利用する場合とは例えば、LDAPの検索を最適化するためにLDAPキャッシュサーバーをセットアップしている環境であるものの、ユーザーがGALに同期できるようにしたい場合などです。

* *両方* : 内部と外部のディレクトリサーバーを両方がGAL検索に使用されます。

|GAL検索で取得できる結果の最大件数 |
ユーザー検索で返されるGAL検索結果の最大件数。この値が定義されていない場合、グローバル設定で定義された値が使用されます。
デフォルト値は100。

|GAL同期アカウント名* |
読み取り専用。GAL同期名と紐づくドメインが表示されます。

|内部GALのデータソース名 |
読み取り専用。内部GAL名が表示されます。

|内部GALのポーリング間隔 |
GAL同期アカウントがLDAPサーバーと同期する頻度を日数、時間、分、秒数のいずれかで定義します。LDAPサーバーとの最初の同期時、LDAPにある全てのGAL内容がGAL同期アカウントのアドレス帳に登録されます。その後の同期は、新規作成、修正、あるいは削除された連絡先情報が更新されます。

|=======================================================================

=== GAL同期アカウントで、GALのアクセス速度を向上させる

GAL同期アカウントは、内部GALや外部GALの作成時、そのドメインに作成されます。複数のメールボックスサーバーを使用している環境では、メールボックスサーバーごとにGAL同期アカウントを作成することができます。GAL同期アカウントの利用により、GAL内の名称へのオートコンプリート機能が速くなります。

GAL同期アカウントがサーバーに作成されると、GALリクエストはドメインのGAL同期アカウントではなくサーバーのGAL同期アカウントを直接使用します。GalSyncResponseには、GAL同期アカウントIDと現在の変更番号を暗号化するトークンが含まれています。クライアントはこれを保存し、次回のGalSyncRequestで使用します。ユーザーは当初の同期で使用したGAL同期アカウントを使って、GAL同期を実行します。何らかの理由でGAL同期アカウントを使用できない場合は従来のLDAPベースの検索が行なわれます。

[NOTE]
GAL同期アカウントはシステムアカウントのため、Zimbraライセンスを利用しません。

GAL同期アカウントの設定時にGALデータソースを定義します。データソースの連絡先情報がGAL同期アカウントのアドレス帳に同期されます。GALモードが*両方* の場合はアカウント内にLDAPのデータソース分、アドレス帳が作成されます。

GAL同期のGALポーリング間隔で、GAL同期アカウントがLDAPサーバーと同期する頻度が決まります。同期の間隔は日数、時間、分、秒数のいずれかです。ポーリング間隔はデータソースごとに設定します。

GAL同期アカウントがLDAPのディレクトリと同期すると、LDAPにある全てのGAL連絡先情報がそのGAL同期アカウントのアドレス帳に追加されます。同期中、アドレス帳は、新規作成、修正、あるいは削除された連絡先情報で更新されます。アドレス帳を直接修正しないでください。LDAPとGALのそのアドレス帳との同期で、直接アドレス帳に修正していた内容は削除されます。

GAL同期アカウントは管理コンソールから作成します。CLIでのこの機能は *zmgsautil* になります。

==== GAL同期アカウントを追加作成する

{product-abbrev}が複数のメールサーバーで構成されている場合、各メールサーバーにGAL同期アカウントをもう一つ追加することができます。

管理コンソール: ::
*ホーム > 設定 > ドメイン*

. もう一つGAL同期アカウントを追加したいドメインをダブルクリックします。

. 画面の右上にある *ギア* アイコンをクリックし、*GALを設定* をクリックします。

. *GALアカウントを追加* をクリックします。

. GAL同期アカウント名項目に、このアカウントの名称を入力します。デフォルト名は利用しないでください。

. このアカウントを適用するメールボックスサーバーを選択します。

. *GALデータソース名* を入力します。GALモード が 「両方」の場合、内部GALと外部GALのデータソース名を両方入力します。

. GAL同期アカウント更新のため、LDAPサーバーと同期すべき頻度を *GALのポーリング間隔* に設定します。

. *完了* をクリックします。

==== GAL同期アカウント名を変更する

GAL同期アカウントのデフォルトアカウント名は *galsync* です。GALモードの設定時に別の名称を指定できます。GAL同期アカウント作成が完了した後のアカウント変更はデータ同期が失敗する要因となるため実施できません。

アカウント名を変更するには、既存のGAL同期アカウントを削除し、そのドメインの新しいGALを作成します。

管理コンソール: ::
*ホーム > 設定 > ドメイン*

. GAL同期アカウント名を変更したいドメインをダブルクリックします。

. 画面の右上にある　*ギア* アイコンの *GALを設定* をクリックしてウィザードを開いたら、GALモードを「内部」に変更します。他の項目は変更しないでください。*完了* をクリックします。

. 管理コンソールの 管理 > アカウントに遷移してドメインのアカウントペインを開き、ドメインのGAL同期アカウントを削除します。

. 設定 > ドメイン に再度遷移して 「GALを設定」 をクリックします。GAL同期アカウント名項目にお好みの名称を入力します。他のGAL設定項目の入力が終わったら、 *完了* をクリックします。ドメインのアカウントペインに新しいGAL同期アカウントが表示されます。

=== 認証モード

認証とは、ディレクトリサーバーへアクセスするユーザーやサーバーを識別し、ユーザーログイン時に入力されたユーザー名とパスワード情報に基づき正当なユーザーにはアクセスを認めるプロセスのことです。

認証方法はドメイン単位で設定します。

管理コンソール: ::
*ホーム > 2 ドメインを設定 > 1 ドメインを作成... -> 認証モード*

.新しいドメイン -- 認証モード
[cols=",a",options="header",]
|=======================================================================
|オプション |説明


|認証メカニズム |
* *内部* : 内部の認証方法は、そのドメインの認証にZimbraディレクトリサーバーを使用します。内部を選択したらそれで設定完了です。

* *外部LDAP* : ディレクトリサーバーへのバインド操作で渡されるユーザー名とパスワードが認証情報です。外部サーバーへバインドするには、LDAP URLとLDAPフィルターの指定とDNパスワードの設定が必要です。

* *外部Active Directory* : Active Directory サーバーへ渡されるユーザー名とパスワードが認証情報です。Active Directory のドメイン名とURLを指定する必要があります。


|=======================================================================

=== 仮想ホストの使用

仮想ホストにより、サーバーに複数のドメイン名をホストすることができます。一般的なドメイン設定は変わりません。

仮想ホストを作成すると、それがユーザーログイン時のデフォルトドメイン名に使用されます。Zimbraウェブクライアントユーザーは、ユーザー名に含まれるドメイン名を入力せずにログインできるようになります。

管理コンソール: ::
*ホーム > 2 ドメインを設定 > 1 ドメインを作成... -> 仮想ホスト*

.新しいドメイン -- 仮想ホスト
[cols=",",options="header",]
|=======================================================================
|*オプション* |*説明*

|仮想ホストを追加 |
ドメインの仮想ホストを識別するための英数字。仮想ホストにはAレコードを使用した有効なDNS設定が必要です。ドメインから仮想ホストを削除するには、ウィザード画面のホスト名の横にある *削除* ボタンをクリックします。

|=======================================================================

Zimbraのウェブクライアントのログインページを開くには、仮想ホスト名をURLとして入力します。例: *https://mail.company.com*.

Zimbraのログイン画面が表示されたら、ユーザー名とパスワードのみ入力します。認証リクエストが該当の仮想ホスト名のドメインを検索します。仮想ホストが見つかれば、そのドメインへの認証が完了します。

=== アカウント制限の設定

各ドメイン内で作成可能な最大アカウント数を制限することができます。作成可能な最大アカウント数はドメイン作成時に設定できます。ドメイン設定を編集して、この数を設定したり修正したりできます。

管理コンソールの 設定 > ドメイン > アカウント制限 ページから、この設定が可能です。このページを設定しない場合、ドメイン内アカウント数に上限はありません。

リソース、スパム、ハムのアカウントはこの数に数えません。

[NOTE]
{product-name}
のライセンスによって定められている最大アカウント数を超えることはできません。

ドメインに複数の提供サービス(COS)がある場合、設定可能な提供サービスを選択すること、そしてその提供サービスに紐付けられるドメインアカウント数を設定することが可能です。これは、ドメインのアカウント制限ページで設定します。使用中の提供サービスアカウントタイプ数はトラッキングされます。全ての提供サービスのアカウント上限が、そのドメインの最大アカウント数を上回るようにはできません。

提供サービスに紐付けられるドメインアカウント数はトラッキングされます。アカウントの全般情報ページにて、紐付けた数とその残数が確認できます。

[[_renaming_a_domain]]
=== ドメイン名を変更する

ドメイン名の変更時は、実際に新しいドメインを作成して、その新しいドメインにすべてのアカウントを移してから、旧ドメインを削除します。すべてのアカウント、エイリアス、配布リスト、リソースのアドレスは、新しいドメイン名に変更されます。LDAPを更新すると、この変更が反映されます。

ドメイン名変更前の作業

* 新しいドメイン名向けにDNSにMXレコードが作成されていることを確認します。
* 完全に機能する、そのドメインのバックアップがあることを確認します。

ドメイン名変更後の作業

* 旧ドメイン名が設定されている外部リファレンスを新しいドメイン名に更新します。これにはバックアップ完了通知など管理者のメールボックスへ送信された自動生成メールが含まれることもあります。直ちに新ドメイン名のフルバックアップを実行します。

[source,bash]
----
zmprov -l rd [旧ドメイン名] [新しいドメイン名]
----

==== ドメイン名の変更プロセス

`zmprov` コマンドの実行により、ドメイン名変更プロセスが以下の流れで進みます。

. 旧ドメイン名のステータスは内部ステータス「シャットダウン」に変わり、ドメインのメールステータスは「保留」に変わります。ユーザーはログインできず、メールはMTAのキューに留まり、アカウントもカレンダーのリソースも配布リストも作成、削除、変更できません。
. 新しいドメインは、内部ステータス「シャットダウン」で、メールステータスは「保留」で作成されます。
. アカウント、カレンダーのリソース、配布リスト、エイリアス、リソースはすべて新しいドメインにコピーされます。
. LDAPを更新して、新しいドメインアドレスを反映します。
. 旧ドメインが削除されます。
. 新しいドメインのステータスを「アクティブ」に変更します。新しいドメインでのメッセージの受信が可能となります。

=== ドメインのエイリアスを追加する

ドメインのエイリアスにて、複数のドメイン名を1つのドメインアドレスへ転送することができます。例えば、使用中のドメイン名がdomain.comでも、ユーザーに@example.comのアドレスを持たせたい場合、domain.comのエイリアスドメインとしてexample.comを作成することができます。user@example.com へメール送信することは、user@domain.com にメール送信することと同じになります。

[NOTE]
ドメインエイリアスはプライマリドメイン名と同じ、ドメイン名です。エイリアスを追加する前に、ドメインを所有し、かつ、その所有権を立証する必要があります。

管理コンソール: ::
*ホーム > 設定 > ドメイン* をアクセスし、右上の *ギア* アイコンより *ドメインエイリアスを追加* をクリックします。

=== ドメインの警告サポートの有効化

警告はドメイン単位で設定します。アップグレード時はそれまでの運用を継続できるように、グローバル警告が各ドメインにあるドメイン専用の警告に自動変換されます。

各ドメインの警告サポートは以下の手順で有効化できます。

. 新しいドメイン(例:example.com)とアカウント(例:user2@example.com )を作成します。
+
[source,bash]
----
$ zmprov cd example.com cb9a4846-6df1-4c18-8044-4c1d4c21ccc5
$ zmprov ca user2@example.com test123 95d4caf4-c474-4397-83da-aa21de792b6a
$ zmprov -l gaa user1@example.com user2@example.com
----

. 警告の使用を有効化します。
+
[source,bash]
----
$ zmprov mcf zimbraDomainMandatoryMailSignatureEnabled TRUE
$ zmprov gcf zimbraDomainMandatoryMailSignatureEnabled
zimbraDomainMandatoryMailSignatureEnabled: TRUE
----

. 新しいドメインに警告を追加します。
+
[source,bash]
----
$ zmprov md example.com
zimbraAmavisDomainDisclaimerText "text disclamer"
zimbraAmavisDomainDisclaimerHTML "HTML disclaimer"

$ zmprov gd example.com zimbraAmavisDomainDisclaimerText zimbraAmavisDomainDisclaimerHTML
# name example.com
zimbraAmavisDomainDisclaimerHTML: HTML disclaimer
zimbraAmavisDomainDisclaimerText: text disclamer

$ zmprov gd eng.example.com
# name eng.example.com
zimbraAmavisDomainDisclaimerText
zimbraAmavisDomainDisclaimerHTML
----

..  最初のMTAにて以下を実行します。
+
[source,bash]
----
/opt/zimbra/libexec/zmaltermimeconfig -e example.com

Enabled disclaimers for domain: example.comm
Generating disclaimers for domain example.com.
----

..  残り全ての追加MTAにて以下を実行します。
+
--
[source,bash]
----
/opt/zimbra/libexec/zmaltermimeconfig
----
* テストとして、アカウント(例:user2@example.com)から、HTML形式とテキスト形式でメール送信します。

* 検証として、HTMLの警告メールとテキストの警告メールが正しく受信されていることを確認します。

* ドメインexample.comを無効化する場合
+
. Zimbraユーザーで最初のMTAにて以下を実行します。
+
[source,bash]
----
/opt/zimbra/libexec/zmaltermimeconfig -d example.com
----
+
.  残りの全MTAにて以下を実行します。
+
[source,bash]
----
/opt/zimbra/libexec/zmaltermimeconfig
----
--

=== 内部ドメインメールの警告を無効化する

ドメインの内部ユーザー間で送受信するメールに警告を追加しないように設定できます。

`attachedzimbraAmavisOutboundDisclaimersOnly` を `TRUE` にします。

上位互換性の保持のため、この属性はデフォルトで `FALSE` です。

=== 警告の機能を無効化する

関連する属性を `FALSE` に設定することで、警告のサポートを完全に無効化できます。

[source,bash]
----
zmprov mcf zimbraDomainMandatoryMailSignatureEnabled FALSE
----

=== ドメインにあるZimlet

ドメインの *Zimlet* ページに、サーバーに配備されているZimletがすべて表示されます。ドメインユーザーに全てのZimletを利用させたいわけではない場合、ドメインで使用できるZimletをリストから選択します。ドメインのZimletページで設定した値は、提供サービスやアカウントで設定されている値をオーバーライドします。

== サーバーの設定を管理する

ZimbraのサーバーはZimbraのサービスパッケージが最低1つインストールされているマシンです。インストールする際、Zimbraのサーバーは自動的にLDAPサーバーへ登録されます。

管理コンソールから、Zimbraソフトを設定している全サーバーのステータスを閲覧することも既存のサーバーレコードの編集や削除することも可能です。サーバーをLDAPに直接追加することはできません。インストール時に新しいホストを登録するように設計されている{product-name} インストール用プログラムを使用して新規サーバーを追加する必要があります。

管理コンソールから、特定のサーバーに遷移したサーバー設定画面で閲覧できる情報。

* 全般情報： サービスのホスト名、LMTP表示名、バインドアドレス、同時に実行できる予定済みタスクの最大スレッド数。

* サービス：有効なサービスのリスト。 リスト内のサービスを有効/無効に設定できます。

* MTA:サーバーの認証方法の有効/無効、グローバル設定と異なるウェブ メールのMTAホスト名、外部配信用のリレーMTAホスト名の指定、サーバーに対するMilterサーバーの有効/無効、Milterのバインドアドレスの指定。
必要に応じて、DNS参照の有効/無効も設定できます。

* IMAP/POP: サーバーにPOPやIMAPの有効/無効、使用するポート番号の指定。IMAP/POPのプロキシを使用している場合、ポート番号が正常であることも確認できます。

* ボリューム：インデックスとメッセージストアのボリューム設定およびHSMポリシーの管理。

* IPアドレスのバインド：サーバーが複数のIPアドレスを使用している場合、IPアドレスのバインドにより、バインド先のインターフェースを指定できます。

* プロキシ：プロキシを設定している場合、サーバーでの設定。

* バックアップ/復元：サーバーのバックアップと復元設定。
サーバーのバックアップと復元を設定すると、グローバル設定のバックアップと復元の設定をオーバーライドします。

サーバーは、こうした値がサーバー設定で設定されていない場合、グローバル設定の値を継承します。グローバル設定から継承できる設定には、MTA、SMTP、IMAP、POP、ウィルス対策、迷惑メール対策の設定があります。

=== サーバーの全般情報

全般情報ページには以下の設定情報があります。

* サーバー表示名と説明

* サービスホスト名

* LMTP表示名、バインドアドレス、同時に実行できる予定済みタスクの最大スレッド数。デフォルトは20スレッドです。

* メールボックス削除間のスリープ時間：サーバーはメッセージの削除期間をスケジュール管理しています。メールボックスからメッセージの削除のスリープ期間は、グローバル設定、またはサーバー設定の全般情報で設定します。デフォルトでは、メールボックス削除を1分ごとに実行します。

リバースプロキシをインストールした場合、プロキシサーバーとバックエンドのメールボックスサーバー間の通信はすべて平文で行う必要があります。*逆引きプロキシの参照ターゲットサーバ* を有効にすると、以下のパラメーターの値が自動的に設定されます。

----
zimbraImapCleartextLoginEnabled TRUE
zimbraReverseProxyLookupTarget TRUE
zimbraPop3CleartextLoginEnabled TRUE
----

「備考」項目に、設定のメモなどを自由に追加・保存することができます。

=== サーバーのMTA設定

管理コンソール: ::
*ホーム > 設定 > サーバー -> _サーバー名_ -> MTA*

*MTA* ページでは以下の設定を表示します。

* 認証:
+
ユーザーが認証できるように、SMTPのクライアント認証を有効にします。認証されたユーザーまたは信頼済みのネットワークのみ、メールのリレーが許可されます。TLS認証が有効な場合、パスワードがそのまま渡されないように、すべてのSMTP認証でTransport Layer Security (SSLの後継)が強制されます。

* ネットワーク: ウェブメールMTAホスト名、ウェブメールMTAタイムアウト、外部配信用のリレーMTA、信頼できるMTAネットワークID、サーバーのDNS参照を有効にする機能があります。

* Milter サーバー
+
*Milterサーバーを有効にする* にチェックが入っている場合、Milterサーバーは配布リストへ送信できる差出人を制限します。

=== IPアドレスのバインドを設定する

サーバーに複数のIPアドレスを使用している場合、IPアドレスのバインドを使用して特定のサーバーにバインドしたい専用IPアドレスを指定できます。

管理コンソール: ::
*ホーム > 設定 > サーバー -> _サーバー_ -> IPアドレスのバインド*

.IPアドレスのバインド
[cols=",",options="header",]
|=======================================================================
|オプション |詳細

|ウェブクライアントサーバーのIPアドレス | HTTPサーバーが待機するインターフェースアドレス

|ウェブクライアントサーバーのSSL IPアドレス |
HTTPSサーバーが待機するインターフェースアドレス

|ウェブクライアントサーバーのSSL Client Cert認証 IPアドレス |
クライアント証明書を受け入れるHTTPSサーバーが待機するインターフェースアドレス

|管理コンソールサーバーのIPアドレス |
HTTPSサーバーが待機する管理コンソールインターフェースアドレス

|=======================================================================


=== {product-abbrev}でSSLの証明書を管理する

証明書とは、様々なホスト、クライアント、サーバー間でセキュアな通信のために使用するデジタル証明です。証明書はサイトの所有者を証明するために使います。

使用可能な証明書は自己署名証明書と商業用の証明書の2種類です。

* *自己署名証明書* ：自己署名証明書は、発行した作成者自身が署名する認証用証明書。
+
証明書のインストールウィザードを使用すると、自己署名の証明書を発行できます。自己署名の証明書を使用して有効期限を変更したい場合に役に立ちます。通常、自己署名証明書はテストに使用します。 +
デフォルトは1825日間(5年間)です。

* *商業用の証明書* 認証局(CA)が発行する証明書で、証明書に含まれている公開鍵は企業(サーバー)の所有者であることを証明します。

{product-name}インストール時に自己署名証明書は自動インストールされるため、テストに使うことができます。{product-name}サーバーを本番環境で使用する際は、商業用の証明書をインストールする必要があります。


[IMPORTANT]
自己証明の環境にあるZCOユーザーの場合、クライアントのWindows証明書ストアへルートCAの証明書を追加しなければ警告メッセージが表示されます。
https://wiki.zimbra.com/wiki/Main_Page[Zimbra Wiki] の
https://wiki.zimbra.com/wiki/ZCO_Connection_Security[ZCO Connection
Security] を参照ください。

=== 証明書をインストールする

証明書署名リクエスト(CSR)を発行するには、専用のフォームにドメイン、会社、国についての詳細を入力し、RSAの秘密キーでCSRを発行します。発行したファイルをコンピュータへ保存し、ご利用の認証局へ送信します。

商業署名入りの証明書を入手するには、管理コンソールにあるZimbraの証明書ウィザードを使用して、RSAの秘密キーと証明書署名リクエスト(CSR)を発行します。

管理コンソール: ::
*ホーム > 1 開始 > 3. 証明書をインストール*

証明書に設定するパラメーターは、下記のガイドを参照してください。

.証明書のインストール
[cols=",",options="header",]
|=======================================================================
|オプション |詳細

|共通名 (CN) |
ウェブサイトへのセキュアなアクセスに使用されるドメイン正式名です。
任意の共通名を使用する予定はありますか？
サーバーにある単一ドメインに複数のサブドメインを一つの証明書で管理したい場合、このチェックボックスをオンにします。アスタリスク (*) が共通名フィールドに追加されます。

|国名 \(C) |
証明書に会社の所在地として表示したい国名。

|都道府県/州 (ST) |
証明書に会社の所在地として表示したい都道府県/州名。

|市区町村 (L) |
証明書に会社の所在地として表示したい市区町村名。

|組織名 (O) |
社名

|組織のユニット (OU) |
ユニット名(あてはまる場合)

|サブジェクト代替名 (SAN) |
SAN(サブジェクト代替名)を使用するなら有効なドメイン名の入力が必要です。SANを使用中、ドメイン名はまず共通名と比較され、その後SANに対してマッチング検索されます。複数のSANを作ることもできます。代替名がこの項目に入力されていると、クライアントは共通名を飛ばしてサーバー名がSANのいずれかとマッチするべく検索します。

|=======================================================================

Zimbraサーバーで発行したCSRをローカルのコンピュータへダウンロードし、VeriSignやGoDaddyのような認証局へ提出します。認証局よりデジタル署名の証明書が発行されます。

認証局より証明書を受信後したら証明書インストールウィザードを再度使用し、{product-name}へインストールします。インストール後、サーバーを再起動して証明書を有効にします。

=== インストール済みの証明書を確認する

現在配備されている証明書の詳細の閲覧が可能です。詳細には証明書の件名、発行者、有効日数、サブジェクト代替名が含まれます。

管理コンソール: ::
*ホーム > 設定 > 証明書 -> _zmhostname_*

証明書には、Zimbra のLDAP、MTA、プロキシなどの様々なZimbraサービスが表示されます。

=== 有効の証明書を維持する

証明書が失効すると{product-abbrev}システムが正常に動作しなくなる恐れがあるため、クライアントや環境の継続利用に向けて、{product-abbrev}にインストールされているSSL証明書の有効状態を保つことが重要です。配備したSSL証明書の有効日数などの情報は{product-abbrev}管理コンソールから確認できます。証明書を定期的に確認して、失効日を把握し、有効状態を保つことを推奨します。

=== ドメインにSSLの証明書をインストールする

{product-name}サーバーのドメインごとにSSL証明書をインストールできます。複数のドメインをサポートするには、Zimbraプロキシを{product-name}
インストールし、正常に設定する必要があります。ドメインごとに、仮想ホスト名が仮想ドメイン名で、仮想IPアドレスがIPアドレスで設定されます。

ドメインごとに商業署名入りの証明書を発行する必要があります。証明書に含まれる公開鍵により、そのドメインに属することを証明します。

Zimbraプロキシ仮想ホスト名とIPアドレスの設定
[source,bash]
----
zmprov md <domain> +zimbraVirtualHostName {domain.example.com} +zimbraVirtualIPAddress {1.2.3.4}
----

[NOTE]
仮想ドメイン名は、Aレコードを使用した有効なDNS構成が必要です。

ドメインの証明書の編集方法

管理コンソール: ::
*ホーム > 1 開始 > 3. 証明書をインストール*

ドメイン用に発行された、署名入りの商業用の証明書と秘密キーのファイルを、選択したドメインの *ドメインの証明書* セクションにコピーします。

image:ja_jp/certificate_domain_load.jpg[Certificate Domain Load]

. 最初はドメインの証明書から、次にルート証明書と中間証明書を降順でコピーします。これにより、証明書のチェーン全体を認証させることができます。

. 証明書を保存する前に、秘密キーのパスワードを全て削除します。
+
パスワードの削除方法は、商用の証明書の提供元に確認してください。

. *アップロード* をクリックします。
+
ドメイン証明書は以下に配備されます。 `/opt/zimbra/conf/domaincerts`

== メッセージをDKIMで認証する

Domain Keys Identified Mail (DKIM) はメール受信者が検証できる方法でメッセージ配信することの責任を、配信する会社に持たせる、ドメインレベルでの認証メカニズムです。DKIMを配置している会社は、送信元サイトもしくは中間サイトです。メッセージ配信が信頼できるかものかどうかは、送信元の会社の評価がベースとなって判断されます。

外部へ送信するメッセージに DKIM電子署名を追加することで、そのメッセージを自組織のドメイン名と関連づけることができます。DKIM署名 は {product-abbrev}でホストされているドメインであれば、いくつでも有効にできます。この機能の利用のために全ドメインを DKIM署名を有効化する必要はありません。

以下を使用してDKIM のメールの認証メカニズムを定義します。

* ドメイン名の識別子
* 公開鍵の暗号化
* DNSベースの公開鍵の配信サービス

DKIM 署名はメッセージのヘッダー項目に追加されます。以下はヘッダー情報の一例です。

----
DKIM-Signature a=rsa-sha1; q=dns;
     d=example.com;
     i=user@eng.example.com;
     s=jun2005.eng; c=relaxed/simple;
     t=1117574938; x=1118006938;
     h=from:to:subject:date;
     b=dzdVyOfAKCdLXdJOc9G2q8LoXSlEniSbav+yuU4zGeeruD00lszZVoG4ZHRNiYzR
----

迷惑メール、スプーフィング、フィッシングなどの詐欺行為を制限するプログラムの一環として、DKIM署名を検証できる受信者が署名者に関する情報を利用することができます。

=== {product-name}にDKIM署名を設定する

外部送信メールのDKIM署名はドメインレベルで行われます。

DKIM 署名を設定するには、コマンドラインでzmdkimkeyutilを実行し、DKIMキーとSelector(公開鍵)を生成します。発行したSelectorをDNSサーバーへ追加します。

.  サーバーにログインし、{product-abbrev}ユーザーとして以下のコマンドを実行します。
+
[source,bash]
----
/opt/zimbra/libexec/zmdkimkeyutil -a -d <example.com>
----
+
DNSサーバーへの追加が必要な、そのドメインの公開DNSレコード情報が表示されます。公開鍵のDNSレコードは、DNSサーバーへ追加する必要のある、そのドメインのDNS TXTレコードとして表示されます。
+
任意： コマンドラインに `-b <\####>` のように `*-b*` を加えると、発行する公開キーのビット数を指定できます。
`-b` を付けない場合、デフォルト設定は2048ビットです。
+
----
DKIM Data added to LDAP for domain example.com with selector B534F5FC-EAF5-11E1-A25D-54A9B1B23156

Public signature to enter into DNS:
B534F5FC-EAF5-11E1-A25D-54A9B1B23156._domainkey IN TXT
"v=DKIM1; k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC+ycHjGL/mJXEVlRZnxZL/VqaN/Jk9VllvIOTkKgwLSFtVsKC69kVaUDDjb3zkpJ6qpswjjOCO+0eGJZFA4aB4BQjFBHbl97vgNnpJq1sV3QzRfHrN8X/gdhvfKSIwSDFFl3DHewKDWNcCzBkNf5wHt5ujeavz2XogL8HfeL0bTwIDAQA B" ; ----- DKIM B534F5FC-EAF5-11E1-A25D-54A9B1B23156 for example.com
----
+
発行されたDKIMデータは、LDAPサーバーにドメインのLDAPとして保存されます。

. ドメインのプロバイダーにて、ドメインのDNSのDKIMのTXTレコードを更新します。

. DNSサーバーを再起動し、DNSレコードがサーバーから正常に返答していることを確認します。

. 公開鍵が秘密鍵と一致するかどうかを確認するには、　`-d`, `-s`, `-x` についての
<<dkim_identifiers,識別子>> テーブルの説明を参照してください。
+
--
[source,bash]
----
/opt/zimbra/common/sbin/opendkim-testkey -d <example.com> -s <0E9F184A-9577-11E1-AD0E-2A2FBBAC6BCB> -x /opt/zimbra/conf/opendkim.conf
----

[[dkim_identifiers]]
.識別子
[cols="1m,2",options="header",]
|====================================================
|パラメーター |説明
|-d |ドメイン名
|-s |Selector
|-x |設定ファイル名

|====================================================
--

=== ドメインのDKIMデータを更新する

DKIMキーの更新時、新しいTXTレコードを使用してDNSサーバーをリロードする必要があります。

以前のキーで署名されたメールを継続して検証できるように、以前のテキストレコードを一定期間、DNSに保存しておくことを推奨します。

{product-abbrev} サーバーにログインし、zimbra ユーザーとして以下のコマンドを実行します。
[source,bash]
----
/opt/zimbra/libexec/zmdkimkeyutil -u -d <example.com>
----

任意： コマンドラインに `-b <\####>` のように  *-b*  を使用すると、発行する公開キーに使用するビット数を指定できます。
`-b` を追加しない場合は、公開キーの基準ビット数は2048ビットです。

. ドメインのプロバイダーにて、ドメインのDNSのDKIMのTXTレコードを更新します。

. DNSサーバーをリロードし、サーバーがDNSレコードを返していることを確認します。

. 公開鍵が秘密鍵と一致することを検証します。識別子テーブルの説明を参照してください。
+
[source,bash]
----
/opt/zimbra/common/sbin/opendkim-testkey -d <example.com> -s <0E9F184A-9577-11E1-AD0E-2A2FBBAC6BCB> -x /opt/zimbra/conf/opendkim.conf
----

=== {product-abbrev}からDKIM署名を削除する

DKIM署名を{product-abbrev}から削除すると、DKIMのデータがLDAPから削除されます。新規作成したメッセージにはドメイン署名が追加されなくなります。ドメインのDKIMを削除した場合、推奨することとして、以前のテキストレコードをDNS内に一定期間残して、以前のキーで署名されたメールを引き続き検証できるようにします。
削除するには以下のコマンドを実行します。
[source,bash]
----
/opt/zimbra/libexec/zmdkimkeyutil -r -d example.com
----

=== ドメインのDKIMデータを取得する

ドメイン、Selector、秘密キー、公開署名、アイデンティティに関する、保存済みのDKIM情報を確認するには、以下のコマンドを実行します。
[source,bash]
----
/opt/zimbra/libexec/zmdkimkeyutil -q -d example.com
----

== 迷惑メール対策の設定を管理する

{product-abbrev} ではSpamAssassinを使用して迷惑メールを処理しています。SpamAssassinは事前に定義されたルールとBayesのデータベースを使用して、メッセージを評価します。メッセージが迷惑メールかどうかはメッセージ評価のパーセントから判断します。33%～75%でタグ付けされたメッセージは迷惑メールと判断され、ユーザーの迷惑メールのフォルダへ配信されます。75%以上でタグ付けされたメッセージはユーザーへ配信せず、削除されます。

迷惑メール対策の設定は変更できます。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > AS/AV*

image:ja_jp/as_av.jpg[Anti-Spam Settings]

. 迷惑メール対策の項目に要件に合うパラメーターを入力します。

. *ギア* アイコンから *保存* を選択し、設定した内容を適用します。
+
--
.迷惑メール対策
[cols="1,2",options="header",]
|=======================================================================
|オプション |説明

|削除しきい値 |
迷惑メールと判断され、配信されない値。 +
デフォルト値は75%

|タグ付けしきい値 |
迷惑メールと判断され、迷惑メールフォルダに配信される値。 +
デフォルト値は33%

|件名のプレフィックス |
スパムとしてタグ付けされたメッセージの件名に追加する文字列。

|=======================================================================
--

メッセージが迷惑メールとしてタグ付けされた場合、そのメッセージは受信者の迷惑メールフォルダへ配信されます。迷惑メールフォルダに格納された未読メッセージ数の確認や、迷惑メールフォルダを開いて迷惑メールとしてタグ付けされたメッセージをレビューすることができます。迷惑メールの学習フィルターを有効にしている場合、メッセージを迷惑メールのフォルダに追加または削除すると、この操作が迷惑メールのフィルターを学習させることになります。

また、SpamAssassinにおけるRBL (Real time black-hole lists) をZimbra のコマンドラインから有効または無効にすることができます。

=== 迷惑メール対策の学習フィルター

迷惑メールの自動学習フィルターはデフォルトで有効にしています。次の２つのフィードバック用メールボックスが学習フィルター用に自動作成されます。

* *迷惑メール(スパム)を学習ユーザー：* 迷惑メールとしてタグ付けされなかったが、迷惑メールとすべきメッセージを学習する。

* *迷惑メールではない(ハム)を学習するユーザー：* 迷惑メールとしてタグ付けされたものの、そうすべきでなかったメッセージを学習する。

こうした学習アカウントに対して、メールボックス容量制限と添付ファイルのインデックスは無効にされています。無効にすることで、メールボックスの容量がいっぱいになってメッセージがバウンスされることを防ぎます。

何を迷惑メールと捕らえるかによって、迷惑フィルターの良好さは変わります。ユーザーがメッセージを迷惑メールのフォルダへ移動したり、迷惑メールのフォルダから別のフォルダへメッセージを移動することは、メッセージを迷惑メールとして新たにタグ付けすることになり、それがSpamAssassinフィルターの学習になります。こうしてタグ付けされたメッセージは、適切な迷惑メール学習メールボックスへと送信されます。

{product-abbrev}がインストールされたとき、最初のMTAにのみ迷惑メールのスパム/ハムをクリーンアップするフィルターが構成されます。 {product-abbrev}迷惑メールの学習ツール(zmtrainsa)は、自動的にスパムとハムのメッセージを収集し、迷惑メールフィルターを学習します。なお、*zmtrainsa* のスクリプトはcrontabのジョブとして設定し、メッセージをSpamAssassinへ配信し、迷惑メッセージの内容および迷惑メッセージではない内容からキーワードなどを収集し、迷惑フィルターを学習させます。*zmtrainsaのスクリプト* は毎日に実行し、学習が終了するとスパムとハムのメールボックスを空にします。

[NOTE]
--
新たにインストールした {product-abbrev}では、 最初にインストールされたMTAへのスパム/ハム学習に制限されます。このMTAをアンインストール、あるいは移動した場合、別のMTAでスパム/ハム学習を有効にする必要がでてきます。 `zmtrainsa
--cleanup`を実行するために、ホストでこれを有効化しているはずだからです。

新しいMTAサーバー上で設定するには以下のコマンドを実行します。

[source,bash]
----
zmlocalconfig -e zmtrainsa_cleanup_host=TRUE
----
--

=== スパムの学習メールボックスを無効にする

{product-abbrev} の既定設定では、全てのユーザーでメッセージを迷惑メールフォルダに移動することによって迷惑メールのフィルター学習に利用されます。

ユーザーに迷惑メールのフィルター学習をさせたくない場合、この機能を無効化できます。

. グローバル設定の `ZimbraSpamIsSpamAccount` と
`ZimbraSpamIsNotSpamAccount` を編集します。

. 指定した属性からメールアドレスを空欄(削除)に設定します。
+
[source,bash]
----
zmprov mcf ZimbraSpamIsSpamAccount ''
zmprov mcf ZimbraSpamIsNotSpamAccount ''
----

上記の属性が空欄時、迷惑メールあるいは迷惑メールではないとしてタグ付けしたメッセージは、迷惑メールの学習用メールボックスにコピーされません。

=== スパムフィルターを手動で学習する

迷惑と非迷惑のトークン、キーワード、文字、短い文字列を迷惑メールのフィルターにあらかじめ学習させたい場合、メッセージをマニュアル操作でmessage/rfc822の添付ファイルとして迷惑メールと非迷惑メールの学習メールボックスに転送します。

`zmtrainsa` の実行時、こうしたメッセージが迷惑メールのフィルター学習に使用されます。精度の高いスコアを達成するために、サンプルメッセージが充分であることを確認してください。メッセージを迷惑メールとしてタグ付けするための判断には、迷惑メールと非迷惑メッセージがそれぞれ最低でも200通必要です。

=== エイリアスのドメインへのバックスキャッタスパムメッセージ受信を防ぐ

バックスキャッタの迷惑メッセージを減らす目的で、エイリアスドメイン宛の *RCPT To:* の内容を検証するZimbra アクセスポリシーデーモンを実行するサービスを実行することができます。

[NOTE]
ドメインエイリアスの作成の詳細は、
https://wiki.zimbra.com[Zimbra wiki] の
https://wiki.zimbra.com/wiki/Managing_Domains[Managing Domains]の記事を参照してください。

. Postfixのローカル設定キーを指定します。
+
[source,bash]
----
zmlocalconfig -e postfix_enable_smtpd_policyd=yes
----

. MTAの制約を定義します。
+
[source,bash]
----
zmprov mcf +zimbraMtaRestriction "check_policy_service unix:private/policy"
----

`postfix_policy_time_limit` キーを設定している理由は、デフォルトでは、Postfix spawn(8)デーモンはPostfixの子プロセスを開始の1000秒後に自動でKILLするためです。これは、SMTPクライアントがSMTPプロセスと接続している限り実行し続け得るポリシーデーモンにとっては短い時間です。

=== Postfixのポリシーデーモンを無効にする

SMTPDポリシーを無効にします。
[source,bash]
----
zmlocalconfig -e postfix_enable_smtpd_policyd=no
----

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > MTA*

ポリシーの制約を定義します。メール受信者のRBLリストとRHSBLのリストのオン・オフをこのMTAページで切り替えることができます。 +

プロトコルチェックで、以下3つのRBLを有効にできます。

* tname

* クライアントは、完全修飾ドメイン形式 (FQDN) のホスト名で接続グリーティングしなければならない -
  `reject_non_fqdn_hostname`

* 差出人のアドレスは、完全修飾ドメイン形式(FQDN)を使用しなければならない - `reject_non_fqdn_sender`

* グリーディングでのホスト名がRFCに反する - `reject_invalid_host`
[source,bash]
----
zmprov mcf -zimbraMtaRestriction "check_policy_service unix:private/policy"
----

以下のRBLの設定も可能です。

* `reject_rbl_client cbl.abuseat.org`
* `reject_rbl_client bl.spamcop.net`
* `reject_rbl_client dnsbl.sorbs.net`
* `reject_rbl_client sbl.spamhaus.org`

受信者制限の一環として、
`reject_rbl_client <rbl hostname>` オプションも使用可能です。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > MTA -> DNS チェック*

MTA設定にあるDNSツールを使用して、制限リストを定義します。

image:ja_jp/dns_checks.jpg[DNS Checks]

最新のRBLリストは
https://en.wikipedia.org/wiki/Comparison_of_DNS_blacklists[Comparison of DNS
blacklists(DNSブラックリストの比較)] の記事を参照してください。


=== コマンドラインでRBLを追加する

. 現在設定されているRBLを確認します。
+
[source,bash]
----
zmprov gacf zimbraMtaRestriction
----

. 新しいRBLタイプを追加します：1つのコマンドに、既存のRBLと新しいRBLを入力します。単語が分かれるRBL名は、入力時にクォーテションで括ってください。
+
[source,bash]
----
zmprov mcf zimbraMtaRestriction [RBL type]
----

.例:全ての制限を追加する場合：
=================================
[source,bash]
----
zmprov mcf \
 zimbraMtaRestriction reject_invalid_hostname \
 zimbraMtaRestriction reject_non-fqdn_hostname \
 zimbraMtaRestriction reject_non_fqdn_sender \
 zimbraMtaRestriction "reject_rbl_client cbl.abuseat.org" \
 zimbraMtaRestriction "reject_rbl_client bl.spamcop.net" \
 zimbraMtaRestriction "reject_rbl_client dnsbl.sorbs.net" \
 zimbraMtaRestriction "reject_rbl_client sbl.spamhaus.org"
----
=================================

=== ホワイトリストと迷惑メールとしてタグ付けされたメッセージに関するグローバルルール

{product-abbrev}でメッセージを受け取る前段階でサードパーティ製アプリケーションの迷惑フィルターを使用している場合、サードパーティの仕様で迷惑メッセージとしてタグ付けされたメッセージは全て迷惑メールのフォルダへ送信されるというのが、{product-abbrev}のグローバルルールです。メッセージの宛先がホワイトリストに登録されていても、迷惑メッセージとしてタグ付けされた場合は迷惑メールのフォルダへ移動されます。

ホワイトリストとして識別したメッセージを迷惑メールのフォルダへ送信したくない場合、 ユーザーのメールボックスに送信するために、 `zimbraSpamWhitelistHeader` と `zimbraSpamWhitelistHeaderValue` を設定する必要があります。このグローバルルールは、{product-abbrev}のMTA迷惑メールフィルタールールとは無関係です。メッセージは依然としてユーザーのフィルタールールを通過します。

ホワイトリストのヘッダーを検索
[source,bash]
----
zmprov mcf zimbraSpamWhitelistHeader <X-Whitelist-Flag>
----

値を設定
[source,bash]
----
zmprov mcf zimbraSpamWhitelistHeaderValue <value_of_third-party_white-lists_messages>
----

== ウイルス対策の設定

Zimbraがインストールされている各サーバーで、ウイルス対策機能は有効です。ウイルス対策機能は、ウィルスがあると判別されたメッセージを隔離用メールボックスに送信するように設定されています。受信者にはメール通知にて、ウイルスによりメッセージが隔離されたことが知らせます。隔離されたメッセージの保持期間は7日間です。

管理コンソールから、システム内でフィルタリング対象としたい迷惑メールを指定することができます。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > AS/AV*

image:ja_jp/as_av.jpg[AS/AV]

. ウイルス対策の項目に、要件に合うパラメーターを入力します。

. *ギア* アイコンから *保存* を選択します。

.ウイルス対策
[cols="1,2",options="header",]
|=======================================================================
|オプション |説明

|定義更新頻度|
Zimbra MTAはデフォルトで、ClamAVのウィルス対策の更新を2時間おきにチェックします。この頻度は1時間から24時間の間で設定可能です。

|暗号化されたアーカイブをブロック |
パスワードで保護されたzipファイルなど、暗号化されたアーカイブはブロックされます。

|受信者に通知を送信|
ウイルス隔離のため、メッセージ配信が中止されたことをメールで警告します。


|=======================================================================

{product-name} インストール中に、警告の通知先となる管理者メールアドレスを設定します。デフォルトは、管理者アカウントがウイルス対策の警告メッセージを受け取るように設定されています。ウイルスが発見されると、このメールアドレスへ自動的に通知されます。

[NOTE]
更新はHTTP通信経由でClamAVのウェブサイトから取得します。

== ZimbraのFree/Busyカレンダー予約機能

Free/Busy機能では、効率的な会議のスケジューリングのために、ユーザーが互いのカレンダーを確認できます。{product-abbrev}とMicrosoft ExchangeのサーバーをまたいでFree/Busy機能のセットアップができます。

{product-abbrev}がMicrosoft Exchange 2003、2007、2010版のサーバーへユーザーのFree/Busyスケジュールを問い合わせることができ、さらに、{product-abbrev}ユーザーのFree/BusyスケジュールをExchangeサーバーに展開することも可能です。

Free/Busyのインターオペラビリティを確立するには、Exchangeのシステムを以下のExchangeセットアップ条件に記載されているとおりに設定し、そして、{product-name}のグローバル設定、ドメイン設定、提供サービス設定、アカウント設定を設定する必要があります。{product-name}の設定は管理コンソールから行なうのが最も簡単です。

=== Exchange 2003/2007/2010でのセットアップ条件

Free/Busy機能のセットアップには、以下が必要です。

* システムに一つのActive Directory (AD)が存在する、またはグローバルカタログが使用可能であること。

* {product-name}サーバーが最低1つのExchangeサーバーのIIS用HTTP(S)ポートに接続可能であること。

* Exchange公開フォルダへのウェブUIがIISで取得可能であること。(http://server/public/)

* {product-name} のユーザーが、Active Directory内で、メールドメインごとに同一の管理グループを使用して、連絡先として登録されること。これは、ExchangeへのFree/Busyレプリカ運用を行なう{product-abbrev} の場合にのみ必要です。

* {product-name} からExchangeへのFree/Busyレプリカ運用を行なう場合、すべての{product-name} ユーザーのアカウント属性の *zimbraForeignPrincipal* にExchangeユーザーのメールアドレスがプロビジョンされること。

=== {product-name}にFree/Busyを設定する
Free/Busyのインターオペラビリティを管理コンソールで設定するには、グローバル設定、ドメイン、提供サービス、アカウントの設定を以下のように設定する必要があります。

* グローバルまたはドメイン単位でExchangeサーバーの設定を設定します。

** Microsoft Exchange サーバーURL：Exchange へのウェブ UI

** Microsoft Exchange 認証スキーマ： *ベーシック* または *フォーム*

*** ベーシックは、HTTPベーシック認証を経由したExchangeへの認証です。

*** フォームは、HTMLフォームに基づく認証としたExchangeへの認証です。

** Microsoft Exchange サーバータイプ： *WebDav* または *ews*

*** Exchange 2003や2007にFree/Busyを使用する場合、WebDAVを選択します。

*** Exchange 2010、SP1にFree/Busyを使用する場合、ews (Exchange Web Service) を選択します。

* Microsoft Exchangeユーザー名とパスワードを入れます。Microsoft公開フォルダにアクセスできる、Active Directory内のアカウント名とパスワードです。RESTやWebDAVインタフェースで、Exchangeサーバーを認証するのに使用します。

* グローバル設定のFree/Busyイントラページ、ドメインのFree/Busyイントラページ、あるいは提供サービス(COS)の詳細設定ページから、Exchange用に *legacyExchangeDN* 属性で使用される  *o* と *ou* 値を追加します。グローバル設定から追加すると、Exchangeに接続するアカウントすべてに適用されます。

* アカウントのFree/Busyインターオプページから、アカウントの外部プリンシパルメールアドレスを設定します。これにより、{product-name}アカウントとAD内の該当オブジェクトとのマッピングがセットアップされます。

[NOTE]
これらの設定をExchangeサーバーで確認するには、Exchange のADSI Editツールを使用し、 `o=` ,
`ou=` , `cn=` 設定の *legacyExchangeDN* 属性を検索します。

=== {product-name} と {product-name} 間のFree/Busyインターオペラビリティ

{product-abbrev} サーバー間に、Free/Busyインターオペラビリティをセットアップできます。Free/Busyのインターオペラビリティは各サーバーに設定します。

[NOTE]
各サーバーは {product-abbrev} 8.0.x 以降を使用している必要があります。

. サーバーのホスト名とポートを入力します。
+
[source,bash]
----
zmprov mcf zimbraFreebusyExternalZimbraURL http[s]://[user:pass@]host:port
----
+
*user:pass* を指定しない場合、サーバーは名無しでfree/busyを検索します。

. サーバーを再起動します。
+
[source,bash]
----
zmcontrol restart
----

. 全てのサーバーに上記の手順1と2を実行します。

== S/MIMEを設定する

S/MIMEはセキュアなメールメッセージを送信するためのスタンダードの１つです。S/MIMEのメッセージは、認証とメッセージの暗号化にデジタル署名を使用します。

現在S/MIME機能は、２種類の方法で実現可能です。

. クライアントマシンにJava 1.6 SEがデプロイされている必要のある、古いクライアントベースのソリューション。
. クライアントマシンにJavaの必要のない、新しいサーバーベースのソリューション。サーバーは全ての暗号化処理を行ないます(推奨)。

=== クライアントベースのソリューションを使用して、S/MIME機能が利用できるようにセットアップする

==== 前提条件

* ユーザーがS/MIMEを利用するには、PKI証明書と秘密キーがなければなりません。利用しているWindowsやApple Mac端末内の証明書ストアへ秘密キーをインストールする必要があります。Firefoxブラウザを使用する場合はブラウザの証明書ストアへインストールします。証明書のインストール方法は、コンピュータやブラウザの該当資料を参照してください。

* S/MIMEが利用できるブラウザ

** Mozilla Firefox 4 以降

** Internet Explorer 8, 9

** Chrome 12 以降

* S/MIMEを利用するには、端末にJava 1.6 SEがデプロイされていなければなりません。されてない場合、催促のエラーが表示されます。

==== S/MIME のライセンス

S/MIMEの機能を有効にする {product-abbrev} ライセンスが必要です。

==== S/MIMEの機能を有効にする

管理コンソール: ::
*ホーム > 設定 > 提供サービス -> _COS名_ -> 機能* +
*ホーム > 管理 > アカウント -> _アカウント名_ -> 機能*

S/MIME機能は、提供サービス(COS)、または各アカウントの機能ページにて有効にすることが出来ます。

. 編集したい 提供サービスまたはアカウントを選択します。
. 「機能」タブにある *S/MIMEを有効にする* にチェックを入れます。
. 画面の右上の *保存* をクリックします。

==== S/MIMEの証明書をインポートする

ユーザーが宛先の公開鍵証明書を次の場所に保存している場合、そのユーザーは暗号化したメッセージをその宛先に送信できます。

* ユーザーのアドレス帳にある宛先の連絡先情報
* 使用しているOSやブラウザのキーストア
* 外部LDAPのディレクトリ

証明書をLDAPディレクトリに公開して、GALから証明書が検索・取得できるようにします。S/MIMEの証明書のフォーマットは、X.509 Base64エンコードDERを使用します。

===== 証明書を検索できるように外部LDAPを設定する

証明書を保管するために外部LDAPを利用する場合、クライアントではなく外部LDAPに対して証明書の検索・取得をするように、Zimbra サーバーを設定することができます。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > S/MIME* +
*ホーム > 設定 > ドメイン -> _ドメイン名_ -> S/MIME*

外部LDAPのサーバー設定は、 *設定→グローバル設定→S/MIME* や *設定→ドメイン→S/MIME* の遷移先で、設定できます。

[NOTE]
グローバル設定は、ドメイン設定にオーバーライドします。

. 「設定→グローバル設定」ページを編集、または「設定→ドメイン」で編集したいドメインを選択します。 *S/MIME* タブを開きます。

. *設定名* に、外部LDAPサーバーを識別するための名称を入力します。 例) *companyLDAP_1*
. *LDAP URL* に、LDAPサーバーのURLを入力します。 例)
*ldap://host.domain:3268*
. DNを使って外部サーバーへバインドする場合、 *S/MIME LDAPバインドDN* にバインドDNを入力します。 例) *administrator@domain*
+
匿名バインドを使用する場合、バインドDN項目とバインドパスワード項目を空白のままにします。

. *S/MIME LDAP検索ベース* 項目に、証明書を探すために検索される、LDAPサーバーの特定のブランチを入力します。
+
例) *ou=Common Users, DC=host, DC=domain*
+
あるいは、検索ベースのDNが自動で見つかるように、 *検索ベースを自動的に検索* にチェックを入れます。これには、S/MIME LDAP検索ベース項目を空にしておく必要があります。

. *S/MIME LDAPフィルター* 項目に、検索用フィルターテンプレートを入力します。このフィルターテンプレートには、次の変換用変数を入れることができます。
+
* %n - @ を含む検索キー(または、@を何も指定しなかったら@を含まない検索キー。)
* %u - @を取り除いた検索キー(例えば、mail=%n)
. *S/MIME LDAP属性* 項目に、ユーザーのS/MIME証明書を入れる外部LDAPサーバー内の属性を入力します。属性が複数の場合はカンマで区切ります。
+
例) "userSMIMECertificate, UserCertificate"
. 画面右上の *保存* をクリックします。

他の外部LDAPサーバーを追加する場合、 *設定を追加* をクリックします。

=== サーバーベースのソリューションを使用して、S/MIME機能の利用をセットアップする

==== 前提条件

クライアントベースのS/MIMEソリューションと同様。ただし、クライアントマシンにJavaは必要ありません。秘密キーをクライアントマシンのローカル/ブラウザの証明書ストアに格納する必要もありません。

==== S/MIMEのライセンス

クライアントベースのS/MIMEソリューションと同様。

==== S/MIMEの機能を有効にする

クライアントベースのS/MIMEソリューションと同様。

==== S/MIMEの証明書をインポートする

クライアントベースのS/MIMEソリューションと同様。ただし、宛先の公開鍵証明書をローカルOSやブラウザのキーストアに保存する必要はありません。この証明書は、前回のS/MIMEバージョンで明記されている、他の場所全てに公開することができます。

==== サーバーベースのS/MIMEソリューションのサポートのために入力されるLDAP属性の一覧

. zimbraSmimeOCSPEnabled

* ユーザーと公開証明書の検証時、サーバーが使用します。
* TRUEの場合、証明書の検証中に失効チェックが行なわれます。
* FALSEの場合、証明書の検証中に失効チェックは行なわれません。

. zimbraSmimePublicCertificateExtensions

* サポートされている、公開証明書ファイルの拡張子。カンマ区切り。
* サポートされている、userCertificate LDAP 属性の形式一覧が入ります。
* デフォルト値: cer,crt,der,spc,p7b,p7r,sst,sto,pem
*  Zimbraウェブクライアントは、サーバーからアップロードされた公開証明書について、このサポートされた形式/拡張子を検索します。

. zimbraSmimeUserCertificateExtensions

* サポートされている、公開証明書ファイルの拡張子。カンマ区切り。
* サポートされている、userSmimeCertificate LDAP 属性の形式一覧が入ります。
* デフォルト値: p12,pfx
* Zimbraウェブクライアントは、サーバーからアップロードされたユーザー証明書について、このサポートされた形式/拡張子を検索します。

==== S/MIMEのメールボックス トラストストアにCA証明書を追加する処理

S/MIMEは、localconfig.xml内で定義されているメールボックス トラストストアパスとパスワードを使用します。

キー名称は次のとおりです。

* mailboxd_truststore
* mailboxd_truststore_password

mailboxd_truststoreキーがlocalconfig.xml内に定義されていない場合、デフォルトで、mailboxd_truststoreの値は以下になります。

* <zimbra_java_home>/jre/lib/security/cacerts

メールボックス トラストストアにCA証明書は、下記コマンドを実行してインポートできます。

[source,bash]
----
keytool -import -alias -keystore <mailboxd_truststore path> -trustcacerts -file <CA_Cert>
----

== 容量管理

=== 保存容量ボリュームの管理

ボリュームページから、Zimbraのメールボックスサーバー内のストレージボリュームを管理できます。 {product-name} インストール時、各メールボックスサーバーにインデックスボリュームとメッセージボリュームが1つずつ設定されます。
新規ボリュームの追加、ボリューム種類の設定、圧縮のしきい値の設定が可能です。

[NOTE]
「Blobを圧縮」が有効の場合、使用中ディスク容量は減りますが、サーバーのメモリー需要は増加します。

==== インデックスボリューム

Zimbraの各メールボックスサーバーに「現在のインデックスボリューム」が設定されています。各メールボックスは「現在のインデックスボリューム」にある恒久ディレクトリに割り当てられます。アカウントの割り当て先ボリュームの変更はできません。

ボリューム容量がいっぱいになったら、新しい「現在のインデックスボリューム」を作成して、新規のアカウントに備えることができます。新規ボリュームの追加、ボリューム種類の設定、圧縮のしきい値の設定が可能です。

「現在の」インデックスボリュームとしてタグ付けされていないボリュームも、割り当てされたアカウントについて継続使用されています。メールボックスからインデックスボリュームとして参照されるボリュームを削除することはできません。

==== メッセージボリューム

新規メッセージの作成時や配信時に、メッセージは現在のメッセージボリュームに保存されます。メッセージボリュームは複数作成できますが、新規メッセージが格納される「現在のボリューム」は１つしか設定できません。ボリューム容量がいっぱいになったら、新しい「現在の」メッセージボリュームを設定できます。「現在の」メッセージボリュームはすべての新規メッセージを受け取ります。新規メッセージが以前のボリュームに保存されることはありません。

「現在の」ボリュームを削除することはできませんし、メッセージが参照しているボリュームを削除することもできません。

=== 階層型ストレージ管理を設置する (*)

[NOTE]
*Zimbra 8.8 より、本機能は2つの異なるバージョンを提供しています。Zimbra 8.8 はスタンダード版と新世代（NG）版を提供しています。Zimbra 8.7 またはそれ以前のバージョンは、スタンダード版のみを提供しています。以下にスタンダード版の詳細を記載しています。Zimbra 8.8 で本機能の NG版を利用する方法につきましては、本ガイドの NG版専用チャプターをご参照ください。

階層型ストレージ管理(HSM：Hierarchical Storage Management) では、古いメッセージ用のストレージボリュームを設定できます。HSMとは、データの経過年数に基づいて、プライマリボリュームから現在のセカンダリボリュームに古いデータを移動させる処理です。

ディスク利用を管理するために、グローバルなHSMポリシーやメールボックスサーバーごとのHSMポリシーを設定します。個々のサーバーに設定されたポリシーはグローバルポリシーとして設定されたポリシーにオーバーライドします。

メールのメッセージやその他のアカウント内アイテムは、HSMポリシーに基づいて、プライマリボリュームからセカンダリボリュームに移されます。ユーザーが移動されたメッセージやアイテムを開くとき、何ら変わりはないため、移動に気づくことはありません。

デフォルトのグローバルHSMポリシーでは30日以上経過したメッセージとドキュメントファイルをセカンダリボリュームへ移します。タスク、予定、連絡先も移動する選択をすることもできます。日数、月数、週数、時間、分で指定した経過期間を過ぎたアイテムを移動するスケジュールも設定できます。

移動するアイテムを選択できる上、検索クエリー言語を使用したHSMポリシーの追加も可能です。

例えば、迷惑メールとしてタグ付けされたメッセージすべてを現在のセカンダリボリュームへ移動する場合、*message:in:junk before:-[x] days* をポリシーに追加します。

[NOTE]
検索文字列をデフォルトのポリシーに追加することも、新しいポリシーを作成することもできます。

==== HSMのセッションをスケジューリングする

セカンダリボリュームにメッセージを移動するセッションは、サーバーOSのcronテーブルにスケジューリングされています。管理コンソールからサーバーを選択後、ボリュームページにて、新しいHSMセッションをマニュアル操作で開始したり、HSMセッションを監視したり、実行中のHSMセッションを強制終了したりできます。

サーバーの *ギア* アイコンメニューからHSMセッションをマニュアル操作で開始することができます。

マニュアルでセッションを強制終了し、処理を再起動すると、HSMセッションがHSMの経過ポリシー条件に一致するエントリをプライマリストアから検索します。前回実行時に移動されたエントリはすでにプライマリストアに存在していないため、対象外になります。

HSMジョブを特定のバッチサイズになるように設定することができます。
`zimbraHsmBatchSize` の属性は、HSMのシングルオペレーションで移動できる最大アイテム件数をグローバルに、あるいはサーバーごとに設定できます。
デフォルトのバッチサイズは10,000です。上限を超える場合、すべての対象アイテムが移動されるまで、HSM処理が繰り返されます。

グローバルなバッチサイズの変更
[source,bash]
----
zmprov mcf zimbraHsmBatchSize <num>
----

サーバーに対するバッチサイズの修正
[source,bash]
----
zmprov ms `zmhostname` zimbraHsmBatchSize <num>
----

== メール保持ポリシーの管理

ユーザーアカウントのメールメッセージ、ゴミ箱、迷惑メールフォルダに対する保持ポリシーを設定できます。基本となるメール保持ポリシーは、提供サービスや個々のアカウントの設定で、メールメッセージ、ゴミ箱、迷惑メールの保持期間を設定することです。

ユーザーがアカウントにある受信トレイやその他のメールフォルダに保持ポリシーを利用することも可能です。ユーザーも独自の保持ポリシーを作成できます。

Zimbra では、ゴミ箱から削除されたメッセージを保存しておくゴミ箱フォルダ機能を有効にできます。有効なとき、メールの保持期間ルールや廃棄ポリシーに基づく保持期間を過ぎたメッセージが、サーバー内のゴミ箱フォルダへ移されます。ユーザーは *完全に削除されるまでにゴミ箱内に保持される有効期間*  で設定されたしきい値までであれば、ゴミ箱フォルダから削除したメッセージを復元できます。

ゴミ箱フォルダ機能が無効な場合は、メールの保持期間が過ぎるとメッセージはサーバーから完全に削除されます。

メッセージの削除を禁止するための訴訟ホールド(Legal Hold)をアカウントに設定することも可能です。

=== メッセージの有効期間

提供サービスや個々のアカウントの設定で、アカウントのフォルダ、ゴミ箱、迷惑メールフォルダからメールメッセージを自動削除する時期を設定できます。

.メール有効期間オプション
[cols="1,2",options="header",]
|=======================================================================
|機能 |詳細

|メールメッセージの有効期間 |
RSSフォルダのデータも含め、フォルダ内のメッセージが自動的に消去されるまでの日数。 +
デフォルトは 0。 +
最低日数は30日です。

|ゴミ箱のメッセージの有効期間 |
ゴミ箱へ移動したメッセージが完全に削除されるまでの日数。 +
デフォルトは30日です。

|迷惑メールメッセージの有効期間|
迷惑メールフォルダへ移動したメッセージが完全に削除されるまでの日数。 +
デフォルトは30日です。

|=======================================================================

=== メールメッセージの完全削除

基準の設定では、サーバーが1分ごとに有効期限を切れたメッセージを自動的に削除します。メールボックス削除のスリープ時間間隔を変更することができます。

メールボックス削除のスリープ時間間隔を分単位でグローバルに定義することが可能です。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > 全般情報*

image:ja_jp/GeneralInformation.jpg[Purge Interval]

例えば、メールボックス削除のスリープ時間間隔を1分に設定している場合、サーバーはMailbox1から期限切れのメッセージを削除後、Mailbox2の期限切れのメッセージを削除するまでに1分間待機します。

メールボックス削除のスリープ時間間隔を「0」に設定していると、メール、ゴミ箱、迷惑メールのメッセージ有効期限が設定されていても、メッセージは自動削除されません。

[NOTE]
ユーザーはメッセージ保持設定を閲覧できないため、メッセージの自動削除ポリシーを設定したら、ユーザーにお知らせください。

=== メッセージの保持ポリシーと廃棄ポリシーを設定する

保持ポリシーや廃棄ポリシーは、グローバル設定あるいは提供サービスの設定として設定することができます。ユーザーはこうしたポリシーを自分のアカウント内のフォルダに自由に選択・適用できます。
ユーザー独自の保持ポリシーや削除ポリシーを作成することも可能です。ユーザーはフォルダのプロパティの編集ダイアログから、管理者がセットアップしたポリシーの有効化や独自のポリシーの作成を行なうことができます。

=== グローバルな保持ポリシー

システムワイドな保持ポリシーや廃棄ポリシーを管理コンソールから管理できます。

保持ポリシーページを使用して、グローバルな保持ポリシーや廃棄ポリシーを管理します。

管理コンソール: ::
*ホーム > 設定 > グローバル設定 > 保持ポリシー*

image:ja_jp/GlobalRetentionPolicy.jpg[Global Retention Policy]

=== 提供サービス用の保持ポリシー

選択した提供サービスの保持ポリシーページを使用して、その提供サービスの保持ポリシーや廃棄ポリシーを管理します。

管理コンソール: ::
*ホーム > 設定 > 提供サービス -> _提供サービス名_ -> 保持ポリシー*

image:ja_jp/COSRetentionPolicy.jpg[COS Retention Policy]

提供サービス用の保持や廃棄ポリシーを使用する場合、 *グローバル設定で定義されたポリシーを引き継がずにCOSレベルのポリシーを有効化します。* のチェックボックスがオンである必要があります。

保持ポリシーは、フォルダへ強制的に自動適用されません。フォルダの保持ポリシーの期限を超えていないアイテムをマニュアル操作で削除する場合、以下の警告メッセージが表示されます。 +
*フォルダの保持期間内にあるメッセージを削除しています。
メッセージを削除しますか？*

廃棄ポリシーのメッセージ有効期限が切れると、アイテムはアカウントから削除されます。このとき、ユーザーのゴミ箱フォルダには移されません。ゴミ箱フォルダ機能が有効であれば、サーバー内のゴミ箱フォルダへ移されます。そうでなければ、メッセージはサーバーから完全に削除されます。

==== メッセージの有効期間が保持/廃棄ポリシーと共に機能する方法

メッセージの有効期限がゼロ(0)以外の値であれば、フォルダに適用している保持ポリシーや廃棄ポリシーに加え、以下の設定が適用されます。

メッセージ有効期間が120日に設定されているとき

* フォルダAに360日間のカスタム廃棄ポリシーがあるとき、120日間後にフォルダAのメッセージが削除されます。

* フォルダBに90日間のカスタム廃棄ポリシーがあるとき、90日間後にフォルダBのメッセージが削除されます。

* フォルダCに150日間のカスタム保持ポリシーがあるとき、120日間後にフォルダCのメッセージが削除されます。

=== ゴミ箱フォルダを管理する

ゴミ箱フォルダ機能が有効であれば、メッセージ、ゴミ箱、または迷惑メールの有効期間が切れると、メッセージはサーバー内のゴミ箱フォルダに移されます。ユーザーは{product-abbrev}上のゴミ箱を右クリックし、 *削除された項目を復元* を選択することで、X日の間に削除したメッセージを復元することができます。このしきい値は *エンドユーザーがゴミ箱の内容を表示できる有効期間* の設定に基づいています。

*完全に削除されるまでにゴミ箱内に保持される有効期間* で、ゴミ箱フォルダのメッセージ保持期間を設定します。保持期間より古いゴミ箱フォルダ内のアイテムは、完全に削除され、復元できません。

管理者は、ゴミ箱フォルダの中身(迷惑メールを含む)にアクセスでき、メッセージの保持期間が切れる前に強制削除することもできます。

==== ゴミ箱フォルダにあるアイテムを検索する

[source,bash]
----
zmmailbox -z -m <user@example.com> search --dumpster -l <#> --types <message,contact,document> <search-field>
----

「Search-field」は、期間 'before:mm/dd/yyyy and after:mm/dd/yyyy' でも、特定の人物へのメール 'to: Joe' または特定の人物から 'from: Joe' のメールでも可能です。

==== ゴミ箱フォルダからアイテムを削除する

ゴミ箱フォルダにあるアイテムは、CLIや管理コンソールから削除できます。

[source,bash]
----
zmmailbox -z -m <user@example.com> -A dumpsterDeleteItem <item-ids>
----

管理コンソール: ::
*ホーム > 設定 > 提供サービス -> _提供サービス名_ -> 機能 -> 全般的な機能*

. *ゴミ箱フォルダ* にチェックを入れて、有効にします。
. *エンドユーザーがゴミ箱の内容を表示できる有効期間* を設定するには、提供サービス名の *詳細設定* の *タイムアウトポリシーセクション* に遷移します。
. *完全に削除されるまでにゴミ箱内に保持される有効期間* を設定するには、提供サービス名の *詳細設定* の *メール保持ポリシー* セクションに遷移します。

=== アカウントに訴訟ホールドを設定する

ゴミ箱フォルダ機能が有効であれば、ユーザーアカウント内のアイテムをすべて保管する訴訟ホールド(Legal Hold)の設定が可能です。

ゴミ箱フォルダ機能を有効にしたとき、 *ゴミ箱フォルダの完全な削除が可能* となる機能も自動で有効化されます。
無効にすることで、ユーザーのゴミ箱フォルダのアイテムを削除する機能が停止します。提供サービスや個々のアカウントの設定で、この値を設定できます。 *ゴミ箱フォルダの完全な削除が可能* が有効なとき、アカウント内のフォルダに設定した全ての削除ポリシーが無視されます。

訴訟ホールドの設定

管理コンソール: ::
*ホーム > 設定 > 提供サービス -> _提供サービス名_ -> 機能* +
*ホーム > 管理 > アカウント -> _アカウント名_ -> 機能*

*機能* ページにある *ゴミ箱フォルダの完全な削除が可能*  のチェックをはずします。

== 管理拡張機能のカスタムモジュール

開発者は、Zimbraの管理コンソールのUIにカスタムモジュールを追加作成することができます。新規ビューの作成や、新しいデータオブジェクト管理の追加、あるいは既存のアイテムを新しいプロパティで拡張したり、既存ビューをカスタマイズすることも可能です。

管理コンソールUIのカスタムモジュール作成方法についての全般情報や最新情報は、Zimbra Wiki
https://wiki.zimbra.com/wiki/Extending_Admin_UI[Extending_Admin_UI]を参照してください。

管理コンソールUIに現在取り込まれているZimbra拡張機能は全て、閲覧のみ可として、コンテンツペインに一覧表示されています。

モジュールを作成した本人だけが削除することができます（「管理拡張機能のモジュールを削除する」を参照してください）。

=== 新しい管理コンソールUIモジュールを配備する

管理コンソール: ::
*ホーム > 設定 > 管理拡張機能*

管理コンソールのアクセスに使用する端末に、モジュールのZipファイルを保存します。

. *ギア* アイコンから *配備* を選択して、*Zimletまたは拡張機能をアップロードおよび配備* ダイアログを表示します。
. アップロードするカスタムモジュールのZipファイルを選択します。
. *配備* ボタンをクリックします。
+
ファイルがアップロードされると即座に拡張機能がサーバーに配備されます。

=== 管理拡張機能のモジュールを削除する

管理拡張機能を削除することで、選択したモジュールとその関連ファイルが全て削除されます。元のZipファイルは削除されません。

管理コンソール: ::
*ホーム > 設定 > 管理拡張機能*

下記手順で、管理拡張機能のカスタムモジュールを削除します。

. 削除したいモジュールを選択し、*ギア* アイコンから *配備解除* を選びます。確認用のメッセージダイアログが表示されます。
. *はい* をクリックすると、処理が実行されます。
