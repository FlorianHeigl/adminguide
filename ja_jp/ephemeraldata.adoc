[[_ephemeral_data]]
= Ephemeral Data(エフェメラルデータ)

{product-name}の通常オペレーションにてLDAPに格納されるエフェメラルデータには主に３つあります。

      - 最終ログインタイムスタンプ (zimbraLastLogonTimestamp)
      - 認証トークン (zimbraAuthTokens)
      - CSRFトークン (zimbraCsrfTokenData)

ユーザー数が少ないメールシステムでは、このようなエフェメラルデータのストレージをLDAPサーバで行えることが可能です。
ただし、大量のアクティブユーザー様のメールシステムでは、短時間に残るデータストレージがLDAPをオーバーロードしてしまう可能性があります。
そのため、このようなエフェメラルデータを外部のサーバへ保管することを推奨しております。

注意：外部ストレージサーバーのインストールおよび管理方法は本書では言及しません。

エフェメラルデータのストレージ場所の設定は次のLDAP属性で行います。

|====================
| 属性 | フォーマット | 説明
| zimbraEphemeralBackendURL | [backend name]:[params] | エフェメラルデータバックエンドURL設定
|====================

現在サポートされているエフェメラルデータの２つのバックエンド

|====================
| バックエンド | フォーマット | 説明
| LDAP    | ldap://default |  デフォルト設定
| SSDB    | ssdb:127.0.0.1:8888 | SSDBサーバーとポート
|====================

高頻度の認証リクエストは、エフェメラルデータのストレージバックエンドに高負荷を発生させます。以下の Zimbra Wiki ページにて、認証リクエストの負荷テストの結果をご参照ください。

* https://github.com/Zimbra/zm-ssdb-ephemeral-store/wiki/Zimbra-and-LDAP-Authentication-Load-Tests[LDAP 認証リクエストの負荷テスト]
* https://github.com/Zimbra/zm-ssdb-ephemeral-store/wiki/Zimbra-and-SSDB-Authentication-Load-Tests[SSDB 認証リクエストの負荷テスト]

== 運用中の {product-name} に SSDB の利用へ変更する方法

すでに稼働中の {product-name} 環境にて、 エフェメラルデータのストレージ用に `LDAP` ではなく `SSDB` を利用するには、次のように設定します。

1. `SSDB` をインストールし、それに設定されているIPアドレスとポート番号をメモします。このデータを次の手順で使用する必要があるためです。詳細は、
   <<_ssdb_configuration_options>> を参照してください。
2. コマンド `/opt/zimbra/bin/zmmigrateattrs` を使って、既存のエフェメラルデータを `SSDB` へ移行します。
3. {product-name} が `SSDB` を使用するように設定します。


== 移行手順

1. 環境にあるマシンのいずれかからコマンドプロンプトを立ち上げます。

[start=2]
. `zmmigrateattrs` ユーティリティを使用して、既存のエフェメラルデータを `SSDB` バックエンドに移行します。

----
sudo su - zimbra
/opt/zimbra/bin/zmmigrateattrs ssdb:<ip address|hostname>:port #該当サーバーの値に変更してください。
----

IPアドレスもしくはホスト名を移行先URLのホスト部分として使用する場合があるかもしれません。いずれにせよ、そこからクラスタ内のすべてのマシンの適切なIPアドレスが導かれる必要があります。入力されたSSDBアドレスから、稼働しているバックエンドが導けない場合、移行処理は終了します。


[start=3]
. `SSDB` を使用するように {product-name} を設定します。

----
sudo su - zimbra
zmprov mcf zimbraEphemeralBackendURL ssdb:<ip address|hostname>:port #該当サーバーの値に変更してください。
----

２．と同様、ホストとポートから、稼働しているSSDBバックエンドが導かれる必要があります。導けない場合、`zimbraEphemeralBackendURL` の値は変更されません。


== 移行の詳細

=== 移行情報

コマンド `zmmigrateattrs --status` を実行すると、最新の移行処理についての情報が表示されます。移行が現在進行中の場合、このコマンドを別のターミナルウィンドウから実行する必要があるかもしれません。これにより、下記の３種類の情報が出力されます。

1. 移行のステータス： IN_PROGRESS(進行中)、COMPLETED(完了)、FAILED(失敗)のいずれか。
2. 移行先として機能するSSDBバックエンドのURL。
3. 移行処理が開始された時点のタイムスタンプ。

移行情報はコマンド `zmmigrateattrs --clear` によりリセット可能です。リセットは、このステータスがシステムの真の状態を反映していない場合にのみ実行するようにしてください。

=== 一時的なバックエンドのURLを変更する

`zimbraEphemeralBackendURL` の値が修正されると、 {product-name} は把握できる最後の移行のステータスをチェックします。その後のシナリオは下記のとおりいくつかに分かれます。

1. 移行が完了しており、URLが新しく入力された値と一致する場合、 `zimbraEphemeralBackendURL` はこの新しい値に変更されて、移行情報はリセットされます。これが想定するユースケースです。
2. 移行が現在進行中の場合、`zimbraEphemeralBackendURL` は更新されません。
3. 移行情報がない、移行が失敗している、新しいURLが移行のURLと不一致、のいずれかにあたる場合、`zimbraEphemeralBackendURL` は更新されますが、データが移行された保証はないことを伝える警告がログに記録されます。


=== エフェメラルデータを転送する

移行処理中と、バックエンドURLが変更されるまでの間は、LDAPと `SSDB` の両方に新しいエフェメラルデータを格納します。これにより、この２つのバックエンドを同期させないようにしています。移行先URLと一致するように `zimbraEphemeralBackendURL` の新しい値が更新されると、移行情報はリセットされ、転送のメカニズムは停止します。この値が不一致の場合、移行情報はリセットされず、転送は続きます。留意すべきこととして、最初の移行からURL変更までに開きがある場合でも、移行の実行は一回のみ必要です。対象のバックエンドはオフラインになるまで最新状態を維持します。しかし、移行終了からバックエンドURL変更までの間に `SSDB` がオフラインになった場合、移行を再実行する必要があります。


こうしたシナリオは下図にて表すことができます。

(左図：移行中と移行後) +
(中央：バックエンドポイントを移行のURLに変更後) +
(右図：バックエンドポイントを異なるURLに変更後)
image:ja_jp/ephemeral-data-migration.png[]

=== 高度な移行のオプション

`zmmigrateattrs` ツールに、移行に関するオプションをいくつか加えることができますが、充分に注意してお使いください。

- `-r` または `--dry-run` オプションにて、実際の移行を行わなくてもアカウントごとの変更内容がコンソールに出力されます。
- `-n` または `--num-threads` オプションにて、移行に使用されるスレッド数を指定します。このオプションを使わない場合は、同期(逐次)移行となります。
- `-a` または `--account` オプションにて、カンマ区切りで指定したアカウント一覧を移行することができます。このオプションはテストまたはデバック時にのみ使用するようにしてください。
- `-d` または `--debug` オプションにて、ログのデバッグが可能となります。

パラメーターに属性名をきちんと明示して渡さない限りは、前述の例のとおり、エフェメラルデータのすべての属性に対して移行が行われることになります。

=== 移行に関する制約

エフェメラルデータの移行は一方通行のプロセスです。 `zmmigrateattrs` スクリプトでは、データを `SSDB` からLDAPに戻すことはできませんし、異なる `SSDB` インスタンス間でデータ移行することもできません。すなわち、移行後に `zimbraEphemeralBackendURL` の値がLDAPに戻されたとしても、以前の認証データは接続不可になり、ユーザーセッションもすべて無効になります。新規 `SSDB` バックエンドへの移行が必要な場合は、事前にデータを新しいロケーションに複製してから、 `zimbraEphemeralBackendURL` の値を変更する必要があります。

これには1つ例外があります。 `SSDB` へ切り替えた直後は最小のデータ損失でバックエンドをLDAPへ安全に戻すことが可能です。この理由は、移行中は元の値がLDAPに保持されるためです。バックエンドを `SSDB` に切り替えると、切り替え時点のエフェメラルデータのスナップショットがLDAP内に残ります。移行のユーティリティは今のところ、領域を空けるためにこのデータを削除するという方法を採っていません。このため、バックエンドを戻すことは可能です。最初に変更してから戻すまでの時間が長くなるほど、LDAPのスナップショットはエフェメラルデータの真の状態から遠ざかることになります。


=== zmprovへの変更

マルチバリューのエフェメラルデータの格納方法の変更に伴い、属性 `zimbraAuthTokens` と `zimbraCsrfTokenData` が `zmprov ga <account>` の一環として返されることはなくなります。 `zimbraLastLogonTimestamp` の値は従来どおり返ってきますが、 -l フラグが使われない場合だけです。 -l フラグを付加した場合、サーバーにアクセスを制限するのはLDAP内の属性のみだからです。こうした属性を `zmprov ma <account>` を使って修正することはエフェメラルデータのバックエンドに関係なく、引き続き可能です。修正を実施するには、次のように、与えられた属性値がそのLDAPフォーマットと一致していなければなりません。 +
認証トークンの場合  `tokenId|expiration|serverVersion` +
CSRFトークンの場合   `data:crumb:expiration`


=== 移行のCSV出力

`zmmigrateattrs` を実行するたびに、ディレクトリ `/opt/zimbra/data/tmp/` 内にCSVファイルが作成されます。このファイルには移行されたアカウントごとの移行情報が含まれます。
例えば移行された属性の数などです。この数はゼロになることもあります。あるアカウントの全てのエフェメラルデータがすでに移行先ストアに存在するなどの場合です。

移行が失敗した場合、同一ディレクトリ内にエラーの詳細のみをレポートする切り出しCSVファイルが作成されます。ファイル名称は実行終了時で記録されます。


=== アカウント削除の実施

エフェメラルデータ削除の動きはSSDBバックエンドとLDAPバックエンドの場合で少々異なります。SSDBがバックエンドの場合、アカウント削除によって、最終ログインタイムスタンプ `zimbraLastLogonTimestamp` 属性はSSDBから消されることになります。しかし、認証トークン `zimbraAuthTokens` とCSRFトークン `zimbraCsrfTokenData` はそのトークンのライフタイムが経過するまでSSDB内に残ります(デフォルトでは2日間)。これに対して、LDAPのエフェメラルデータの場合は、アカウント削除処理の一部として、即座に一掃されます。
