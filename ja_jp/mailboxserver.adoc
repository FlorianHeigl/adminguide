[[zimbra_mailbox_server]]
= Zimbraのメールボックスサーバー
:toc:

Zimbraのメールボックスサーバーは、メッセージ、連絡先、カレンダー、添付ファイルなど、メールボックスのすべてのコンテンツを管理するサーバーです。

Zimbraのメールボックスサーバーではバックアップとログファイルを専用のボリュームに保持します。各サーバーがアクセスできるのは、自身のサーバー内にあるストレージボリュームのみです。他のサーバーへの読み込み、書き込み、閲覧はできません。

== メールボックスのサーバーについて

アカウントは１メールボックスサーバー内に設定され、各アカウントに紐づくメールボックスには、メッセージ、添付ファイル、カレンダー、連絡先、そのアカウントのコラボレーションファイルが入っています。

各Zimbraメールボックスサーバーには、そのサーバーに存在するメールボックス用に、メッセージストア、データストア、インデックスストアがスタンドアロンの状態で存在します。ここからは、各ストアとディレクトリの場所についての概要を説明します。

=== メッセージストア

メッセージ本文と添付ファイルを含めたメッセージの内容は全て、MIMEフォーマットにてメッセージストアに保存されます。

デフォルトでは、メッセージストアはメールボックスサーバー内 `/opt/zimbra/store` 配下に格納されます。各メールボックスは、その内部メールボックスIDにちなんだ固有のディレクトリを持っています。メールボックスIDは、システム全体ではなく個々のサーバー内でのみ、一意です。

受信者が複数であるメッセージの場合、メッセージ保存領域に格納されるのは１件です。UNIXシステム内のユーザーごとの固有メールボックスディレクトリには、この実ファイルへのハードリンクが格納されます。

{product-name} がインストールされると、各メールボックスサーバーにインデックスボリュームとメッセージボリュームが1つずつ設定されます。メールボックスはそれぞれ、現在のインデックスボリューム内のディレクトリに固定で割り当てられます。新たに配信あるいは作成されたメッセージは、現在のメッセージボリュームに保存されます。

メールストレージ管理として階層型ストレージ管理(HSM)ポリシーを実装することで、比較的古いメッセージのストレージボリュームを設定できます。詳細は <<managing_configuration,設定を管理する>>を参照してください。

=== データストア

データストアとはSQLデータベースの１つで、内部メールボックスIDとユーザーアカウントとがリンク付けされているところです。スレッド、メッセージの保存先を示すポインター、タグなど、メッセージのメタデータはすべてファイルシステムに格納されます。SQLデータベースファイルは `/opt/zimbra/db` にあります。

各アカウント(メールボックス)は、1サーバーにしか入りません。そのサーバーに存在するメールボックスのデータを格納するデータストアがスタンドアロンの状態で存在します。

* データストアは、メールボックスIDとユーザーのLDAPアカウントをマッピングします。{product-name} データベース内の第一識別子はZCSメールボックスIDであり、ユーザー名やアカウント名ではありません。メールボックスIDはシングルメールボックスサーバー内では一意です。
* ユーザーのタグ定義、フォルダ、連絡先、カレンダーの予定、タスク、ブリーフケースのフォルダ、フィルターのルールなどのメタデータは、データストアデータベースに格納されています。
* メッセージの閲覧状況、関連タグなどのメッセージ関連情報は、データストアデータベースに格納されています。

=== インデックスストア

インデックスや検索の技術は、Apache Luceneを用いて提供しています。メッセージを受信した際に、メッセージ内容と添付ファイルは自動でインデックスされます。インデックスファイルは各アカウントに紐づき、`/opt/zimbra/index` 配下に保存されます。

トークン化とインデックスのプロセスを管理者やユーザーが設定することはできません。

image::Tokenization.jpg[Index Store]

プロセスの説明

1.  Zimbra のMTAは、受信したメッセージをそのアカウントのメールボックスが存在しているメールボックスサーバーにルートします。
2.  そのメールボックスサーバーは、メッセージのヘッダーや本文、添付ファイル(PDFファイルやMicrosoft Wordドキュメントなど)を解析し、単語をトークン化します。
3.  インデックスファイル作成のため、メールボックスサーバーは、トークン化した情報をLuceneへ渡します。

[NOTE]
トークン化とは単語単位でのインデックスです。電話番号、メールアドレス、ドメイン名などの代表的なパターンは、上の図のようにトークン化されます。

== ウェブアプリケーションサーバー

Jettyウェブアプリケーションサーバーはどのストアサーバー上でもウェブアプリケーション(webapps)を実行し、単体または複数のウェブアプリケーションサービスを利用できるようにします。

=== メールストアサービス

メールストアサービスにより、メールボックス/アカウントのデータへのバックエンドアクセスが可能です。
メールストアのウェブアプリケーションには以下が含まれます。

* メールストア(メールサーバー) = `/opt/zimbra/jetty/webapps/service`
* Zimlets = `/opt/zimbra/jetty/webapps/zimlet`

=== ユーザーインターフェースサービス

ユーザーインターフェースサービスでは、メールボックスのアカウントデータと管理コンソールへのフロントエンドユーザーインターフェースのアクセスを提供します。以下を含みます。

* Zimbraウェブクライアント = `/opt/zimbra/jetty/webapps/zimbra`
* Zimbra管理コンソール = `/opt/zimbra/jetty/webapps/zimbraAdmin`
* Zimlet = `/opt/zimbra/jetty/webapps/zimlet`

== ウェブアプリケーションサーバースプリット

ウェブアプリケーションサーバースプリット機能により、メールストアのサービス(メールサーバー)とユーザーインターフェースのサービス(ウェブクライアントサーバー)を分けることも可能です。

例えば、html/cssページなどの固定UIコンテンツを提供する「zimbra, zimbraAdmin」というウェブアプリケーションをウェブクライアントサーバーで実行し、すべてのSOAPリクエストを処理する「service」というウェブアプリケーションをメールサーバーで実行します。この２つのサーバーはスプリットモードで動いています。

ウェブアプリケーションサーバースプリット機能には以下のメリットがあります。

* ウェブクライアントとメールサーバーを分割することでカスタマイズのプロセスが簡単になり、メールサーバーを再起動せずに新しくカスタマイズしたUIや更新したUIを提供できるようになります。つまり、ダウンタイムが発生しません。
* ZimbraウェブクライアントやZimbra管理コンソールをカスタマイズする場合、メールサーバーを停止させずに、ウェブクライアントサーバーをオフラインにしてカスタマイズやメンテナンスを行なうことができます。
* ウェブクライアントは、メールボックスのアカウントとは全く関係がありません。つまり、どのウェブクライアントサーバーでも、アカウントのリクエストを処理できます。

=== ウェブアプリケーションサーバースプリットのインストールと設定方法

ウェブアプリケーションサーバースプリットのインストールと設定方法に関しては {product-name} Multi-Server Installation Guide を参照してください。

== メールボックスのサーバーをバックアップする

{product-name}には、{product-name}サーバーごとに設定可能なバックアップマネージャーがあり、バックアップと復元の両機能を実施できます。バックアッププロセスの実行のために{product-name}サーバーを停止する必要はありません。バックアップマネージャーを使用してシングルユーザーのメールボックスを復元できます。１ユーザーのメールボックスが破損した時に、システム全体を復元する必要はありません。完全バックアップと増分バックアップは `/opt/zimbra/backup` に保存されます。詳細は <<backup_and_restore,バックアップと復元>>を参照してください。

Zimbraの各メールバックスサーバーは、最後の増分バックアップ以降にメッセージストアサーバーで処理された、現在のトランザクションとアーカイブのトランザクションの入ったRedoログを生成します。サーバー復元時、バックアップファイルを完全に復元し終わったら、アーカイブのRedoログと使用中の現在のRedoログに保存されているRedoログをすべてリプレイし、システムが落ちた地点まで戻します。

== メールボックスのサーバーログ

{product-name} のシステム環境は、１つまたは複数のメールボックスサーバーとサードパーティ製のコンポーネントで構成されています。いずれのコンポーネントからもログデータが出力される可能性はあります。ローカルのログは `/opt/zimbra/log` に保存されます。

{product-name}ログメッセージを選択すると、SNMPトラップが生成されます。SNMP監視ソフトウェアを用いれば、これをキャプチャできます。詳細については <<monitoring_zcs_servers,{product-abbrev} サーバーの監視>>を参照してください。

[NOTE]
システムログ、Redoログ、バックアップしたセッションを別々のディスクに保存することにより、ディスク破損時における復旧不可能なデータロスのリスクを最小限に留めるようにしてください。
